 <!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>《陸王》× MVP/PMF｜單頁互動學習</title>
  <style>
    /* =========================================================
       Bauhaus + Neumorphism (高對比可讀性版本)
       - 單檔：不拆 CSS/JS
       - 台灣用語
       ========================================================= */
    :root{
      --bg:#f4f5f7;
      --panel:#ffffff;
      --ink:#111827;
      --muted:#4b5563;
      --muted2:#6b7280;
      --line:#e5e7eb;

      --bau-red:#e11d48;
      --bau-blue:#2563eb;
      --bau-yellow:#f59e0b;
      --bau-green:#10b981;
      --bau-black:#111827;

      --shadow1: 10px 10px 24px rgba(17,24,39,.12);
      --shadow2: -10px -10px 24px rgba(255,255,255,.9);
      --shadow-inset: inset 8px 8px 16px rgba(17,24,39,.10), inset -8px -8px 16px rgba(255,255,255,.9);

      --radius:20px;
      --radius-sm:14px;
      --radius-xs:10px;

      --max: 1240px;
      --side: 360px;

      --fz-hero: clamp(22px, 2.2vw, 30px);
      --fz-h1: clamp(18px, 1.6vw, 22px);
      --fz-h2: 16px;
      --fz: 15px;
      --fz-sm: 13px;
      --fz-xs: 12px;

      --pad: 18px;
      --pad-sm: 12px;
      --pad-lg: 22px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", "PingFang TC", "Noto Sans TC", "Microsoft JhengHei", Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 10% 0%, rgba(245,158,11,.12), transparent 60%),
                  radial-gradient(900px 900px at 90% 10%, rgba(37,99,235,.10), transparent 55%),
                  radial-gradient(900px 900px at 40% 100%, rgba(16,185,129,.10), transparent 55%),
                  var(--bg);
    }
    a{color:inherit; text-decoration:none}
    button, input, select, textarea{
      font: inherit;
      color:inherit;
    }
    textarea{min-height:84px; resize:vertical}
    .container{
      max-width: var(--max);
      margin: 0 auto;
      padding: 16px 14px 80px;
    }

    /* Topbar */
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: rgba(244,245,247,.75);
      border-bottom: 1px solid rgba(229,231,235,.8);
    }
    .topbar-inner{
      max-width: var(--max);
      margin: 0 auto;
      padding: 10px 14px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 280px;
    }
    .logo{
      width: 38px;
      height: 38px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(225,29,72,.95), rgba(245,158,11,.92));
      box-shadow: var(--shadow1), var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .logo:before{
      content:"";
      position:absolute;
      width:18px;height:18px;
      background: rgba(255,255,255,.92);
      border-radius: 6px;
      left: 8px; top: 10px;
      transform: rotate(10deg);
    }
    .brand h1{
      margin:0;
      font-size: 15px;
      line-height: 1.1;
      letter-spacing:.2px;
    }
    .brand .sub{
      margin-top:2px;
      font-size: var(--fz-xs);
      color: var(--muted);
    }

    .tabs{
      flex:1;
      display:flex;
      gap:8px;
      flex-wrap: nowrap;
      overflow:auto;
      padding-bottom: 2px;
      scrollbar-width: thin;
    }
    .tab{
      white-space: nowrap;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.8);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      font-size: var(--fz-sm);
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease, box-shadow .18s ease, background .18s ease;
    }
    .tab:hover{transform: translateY(-1px)}
    .tab.active{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.86));
      border-color: rgba(17,24,39,.10);
      box-shadow: var(--shadow1), var(--shadow2);
      outline: 3px solid rgba(37,99,235,.18);
    }

    .top-actions{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .chip{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.85);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      font-size: var(--fz-xs);
      color: var(--muted);
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--bau-green);
      box-shadow: 0 0 0 4px rgba(16,185,129,.16);
    }

    .hamburger{
      display:none;
      width: 42px; height: 42px;
      border-radius: 16px;
      border: 1px solid rgba(229,231,235,.9);
      background: rgba(255,255,255,.85);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      cursor:pointer;
    }
    .hamburger span{
      display:block;
      width: 18px; height: 2px;
      background: var(--ink);
      margin: 0 auto;
      position:relative;
      top: 0;
    }
    .hamburger span:before,
    .hamburger span:after{
      content:"";
      position:absolute;
      left:0;
      width: 18px; height: 2px;
      background: var(--ink);
    }
    .hamburger span:before{top:-6px}
    .hamburger span:after{top:6px}

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1fr var(--side);
      gap: 16px;
      align-items:start;
      margin-top: 14px;
    }
    .main{
      min-width: 0;
    }
    .side{
      position: sticky;
      top: 74px;
      min-width: 0;
    }

    .panel{
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(229,231,235,.95);
      border-radius: var(--radius);
      box-shadow: var(--shadow1), var(--shadow2);
      padding: var(--pad);
      overflow:hidden;
    }
    .panel + .panel{margin-top: 12px}

    .hero{
      display:flex;
      gap: 14px;
      align-items:flex-start;
    }
    .hero-badge{
      width: 54px; height: 54px;
      border-radius: 20px;
      background: linear-gradient(135deg, rgba(37,99,235,.92), rgba(16,185,129,.88));
      box-shadow: var(--shadow1), var(--shadow2);
      flex:0 0 auto;
      position:relative;
      overflow:hidden;
    }
    .hero-badge:after{
      content:"";
      position:absolute;
      width: 56px; height: 56px;
      border-radius: 26px;
      background: rgba(245,158,11,.40);
      left: 22px; top: 10px;
      transform: rotate(20deg);
    }
    .hero h2{
      margin:0;
      font-size: var(--fz-hero);
      letter-spacing:.2px;
    }
    .hero p{
      margin: 8px 0 0;
      color: var(--muted);
      line-height: 1.6;
      font-size: var(--fz);
    }

    .section-title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin: 0 0 10px;
    }
    .section-title h3{
      margin:0;
      font-size: var(--fz-h1);
    }
    .kicker{
      font-size: var(--fz-xs);
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .pill{
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.9);
      font-size: var(--fz-xs);
      color: var(--muted);
    }

    /* Buttons */
    .btn{
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.9);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      transition: transform .06s ease, box-shadow .18s ease;
      user-select:none;
      font-size: var(--fz-sm);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .btn:hover{transform: translateY(-1px)}
    .btn:active{transform: translateY(0px); box-shadow: var(--shadow-inset)}
    .btn.primary{
      border-color: rgba(37,99,235,.35);
      background: linear-gradient(180deg, rgba(37,99,235,.16), rgba(255,255,255,.9));
      outline: 3px solid rgba(37,99,235,.14);
    }
    .btn.danger{
      border-color: rgba(225,29,72,.35);
      background: linear-gradient(180deg, rgba(225,29,72,.14), rgba(255,255,255,.9));
      outline: 3px solid rgba(225,29,72,.10);
    }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }
    .btn.small{padding: 8px 10px; border-radius: 12px; font-size: var(--fz-xs)}
    .btn.disabled{
      opacity:.55;
      cursor:not-allowed;
      filter: grayscale(.1);
    }

    /* Forms */
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .col{flex: 1 1 220px; min-width:220px}
    .field{
      display:flex; flex-direction:column; gap:6px;
      margin-top: 10px;
    }
    label{
      font-size: var(--fz-xs);
      color: var(--muted);
    }
    .input, select, textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.95);
      padding: 10px 12px;
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow-inset);
      outline: none;
    }
    .input:focus, select:focus, textarea:focus{
      outline: 3px solid rgba(37,99,235,.16);
      border-color: rgba(37,99,235,.30);
    }
    .hint{font-size: var(--fz-xs); color: var(--muted2); line-height:1.5}

    /* Cards + Lists */
    .card{
      border-radius: var(--radius);
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.88);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      padding: var(--pad);
    }
    .card + .card{margin-top: 12px}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap: 12px}
    .grid3{display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px}
    .small-muted{font-size: var(--fz-xs); color: var(--muted2)}

    /* Timeline */
    .timeline{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .tl-item{
      border-radius: 16px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.90);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      padding: 12px 12px;
      cursor:pointer;
      user-select:none;
      transition: transform .06s ease;
    }
    .tl-item:hover{transform: translateY(-1px)}
    .tl-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .tl-title{
      display:flex; align-items:center; gap:10px;
      font-weight: 650;
      font-size: var(--fz);
    }
    .tl-dot{
      width: 12px; height: 12px; border-radius: 999px;
      background: var(--bau-yellow);
      box-shadow: 0 0 0 5px rgba(245,158,11,.16);
      flex:0 0 auto;
    }
    .tl-body{
      margin-top: 8px;
      color: var(--muted);
      font-size: var(--fz-sm);
      line-height: 1.6;
      display:none;
    }
    .tl-item.open .tl-body{display:block}
    .tl-item.open .tl-dot{background: var(--bau-blue); box-shadow: 0 0 0 5px rgba(37,99,235,.16)}

    /* Quiz */
    .quiz{
      display:grid;
      gap: 12px;
    }
    .q{
      border-radius: 18px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.90);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      padding: 12px 12px;
    }
    .q-title{
      font-weight: 700;
      font-size: var(--fz);
      margin: 0 0 8px;
    }
    .opts{display:grid; gap:8px}
    .opt{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.86);
      cursor:pointer;
      user-select:none;
    }
    .opt input{margin-top:3px}
    .opt:hover{outline: 3px solid rgba(245,158,11,.14)}
    .opt.correct{outline: 3px solid rgba(16,185,129,.18)}
    .opt.wrong{outline: 3px solid rgba(225,29,72,.18)}
    .feedback{
      margin-top: 8px;
      font-size: var(--fz-sm);
      color: var(--muted);
      line-height:1.6;
      display:none;
    }
    .q.show-feedback .feedback{display:block}

    /* Market */
    .mode-toggle{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .mode-btn{
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.88);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      cursor:pointer;
      user-select:none;
    }
    .mode-btn.active{
      outline: 3px solid rgba(37,99,235,.16);
      border-color: rgba(37,99,235,.30);
    }

    .result-strip{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .metric{
      border-radius: 18px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      padding: 12px 12px;
      min-width: 0;
    }
    .metric .k{font-size: var(--fz-xs); color: var(--muted)}
    .metric .v{
      margin-top: 6px;
      font-size: 18px;
      font-weight: 800;
      letter-spacing:.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .metric .s{margin-top:2px; font-size: var(--fz-xs); color: var(--muted2)}

    .sliders{
      margin-top: 10px;
      display:grid;
      gap: 10px;
    }
    .slider{
      border-radius: 18px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.90);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      padding: 12px 12px;
    }
    .slider-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .slider-top .name{font-weight:700}
    .slider-top .val{font-size: var(--fz-xs); color: var(--muted)}
    input[type="range"]{width:100%}

    .canvas-wrap{
      margin-top: 10px;
      border-radius: 18px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow-inset);
      padding: 12px 12px;
    }
    canvas{width:100%; height:220px; display:block}
    .plot-caption{font-size: var(--fz-xs); color: var(--muted); margin-top: 8px; line-height:1.4}

    /* Side panel content */
    .progress-list{
      display:grid; gap: 8px;
      margin-top: 8px;
    }
    .pitem{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.90);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
    }
    .pitem .name{font-size: var(--fz-sm); font-weight:650}
    .badge{
      font-size: var(--fz-xs);
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      color: var(--muted);
    }
    .badge.done{border-color: rgba(16,185,129,.35); color: rgba(5,150,105,1)}
    .badge.go{border-color: rgba(245,158,11,.35); color: rgba(180,83,9,1)}
    .badge.todo{border-color: rgba(107,114,128,.25); color: var(--muted2)}

    /* Notes */
    .notes-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .notes-list{
      display:grid; gap: 10px;
      margin-top: 10px;
      max-height: 380px;
      overflow:auto;
      padding-right: 6px;
    }
    .note{
      border-radius: 16px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
      padding: 10px 10px;
    }
    .note-top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 6px;
    }
    .note-title{
      font-weight: 800;
      font-size: var(--fz-sm);
      margin:0;
    }
    .note-meta{
      font-size: var(--fz-xs);
      color: var(--muted2);
      white-space: nowrap;
    }
    .note-content{
      font-size: var(--fz-sm);
      color: var(--muted);
      line-height: 1.6;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .note-actions{
      display:flex;
      gap:8px;
      margin-top: 8px;
      flex-wrap:wrap;
    }

    /* Mobile */
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
      .side{position: static}
      .brand{min-width: unset}
      .tabs{display:none}
      .hamburger{display:inline-flex; align-items:center; justify-content:center}
    }

    /* Mobile tab drawer */
    .drawer{
      display:none;
      position: fixed;
      inset: 0;
      background: rgba(17,24,39,.38);
      z-index: 80;
      padding: 14px;
    }
    .drawer.open{display:block}
    .drawer-panel{
      max-width: 520px;
      margin: 0 auto;
      border-radius: 22px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.95);
      box-shadow: var(--shadow1), var(--shadow2);
      padding: 12px 12px;
    }
    .drawer-head{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 6px 6px 10px;
      border-bottom: 1px solid rgba(229,231,235,.95);
    }
    .drawer-title{font-weight: 900}
    .drawer-tabs{
      display:grid;
      gap: 8px;
      padding: 10px 6px 6px;
    }

    /* Toast */
    .toast-wrap{
      position: fixed;
      right: 14px;
      bottom: 14px;
      z-index: 120;
      display:grid;
      gap:10px;
      max-width: min(420px, calc(100vw - 28px));
    }
    .toast{
      border-radius: 16px;
      border: 1px solid rgba(229,231,235,.95);
      background: rgba(255,255,255,.92);
      box-shadow: var(--shadow1), var(--shadow2);
      padding: 10px 12px;
      display:flex; gap:10px; align-items:flex-start;
    }
    .toast .bar{
      width: 10px;
      border-radius: 999px;
      background: var(--bau-blue);
      box-shadow: 0 0 0 5px rgba(37,99,235,.10);
      flex:0 0 auto;
      margin-top: 2px;
    }
    .toast .msg{font-size: var(--fz-sm); color: var(--muted); line-height: 1.5}
    .toast .x{margin-left:auto}
  </style>
</head>

<body>
  <!-- Topbar -->
  <div class="topbar">
    <div class="topbar-inner">
      <div class="brand" title="單頁互動｜本地暫存｜可下載">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>《陸王》× MVP/PMF｜單頁互動學習</h1>
          <div class="sub">三小時課｜市場規模 × Fit 階段 × MVP 實驗 × 轉向</div>
        </div>
      </div>

      <div class="tabs" id="tabs"></div>

      <button class="hamburger" id="hamburgerBtn" aria-label="開啟選單">
        <span></span>
      </button>

      <div class="top-actions">
        <div class="chip" title="本地暫存狀態">
          <div class="dot" id="saveDot" aria-hidden="true"></div>
          <div id="saveLabel">已暫存</div>
        </div>
        <button class="btn small" id="quickNoteBtn" title="新增筆記">
          ＋筆記
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Drawer -->
  <div class="drawer" id="drawer">
    <div class="drawer-panel">
      <div class="drawer-head">
        <div class="drawer-title">導覽</div>
        <button class="btn small" id="drawerClose">關閉</button>
      </div>
      <div class="drawer-tabs" id="drawerTabs"></div>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- Main -->
      <div class="main" id="main"></div>

      <!-- Side -->
      <div class="side">
        <div class="panel">
          <div class="section-title">
            <h3>進度</h3>
            <div class="kicker">
              <span class="pill" id="versionNamePill">版本：未命名</span>
            </div>
          </div>
          <div class="small-muted">完成狀態只用來幫你掌握節奏；不會影響你下載成果。</div>
          <div class="progress-list" id="progressList"></div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
            <button class="btn small" id="saveAsBtn">另存版本</button>
            <button class="btn small" id="restoreBtn">還原版本</button>
          </div>
        </div>

        <div class="panel">
          <div class="notes-head">
            <h3 style="margin:0; font-size: var(--fz-h1)">筆記</h3>
            <button class="btn small" id="addNoteBtn">＋新增</button>
          </div>
          <div class="small-muted" style="margin-top:6px">
            你可以把關鍵知識、討論結論、或各頁籤成果快照加入筆記。可刪改、可下載。
          </div>
          <div class="notes-list" id="notesList"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast-wrap" id="toastWrap" aria-live="polite"></div>

  <script>
    /* =========================================================
       Part 1/多段輸出：
       - 核心框架：tab路由、state、暫存、筆記、Tab1/Tab2
       - Tab3/4/5/6/7 會在下一段加入（保留接口）
       ========================================================= */

    // ---------- Utilities ----------
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);
    const nowISO = () => new Date().toISOString();

    function formatMoney(n){
      if (!isFinite(n)) return "—";
      const abs = Math.abs(n);
      const unit = abs >= 1e8 ? "億" : abs >= 1e4 ? "萬" : "";
      let v = n;
      if (unit === "億") v = n/1e8;
      else if (unit === "萬") v = n/1e4;
      const s = v.toLocaleString("zh-Hant", { maximumFractionDigits: 2 });
      return unit ? `${s}${unit}` : `${n.toLocaleString("zh-Hant")}`;
    }

    function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

    // ---------- Toast ----------
    function toast(msg, tone="info"){
      const wrap = $("#toastWrap");
      const el = document.createElement("div");
      el.className = "toast";
      const bar = document.createElement("div");
      bar.className = "bar";
      if(tone==="ok") bar.style.background = "var(--bau-green)";
      if(tone==="warn") bar.style.background = "var(--bau-yellow)";
      if(tone==="bad") bar.style.background = "var(--bau-red)";

      const p = document.createElement("div");
      p.className = "msg";
      p.textContent = msg;

      const x = document.createElement("button");
      x.className = "btn small ghost x";
      x.textContent = "✕";
      x.onclick = () => el.remove();

      el.appendChild(bar);
      el.appendChild(p);
      el.appendChild(x);
      wrap.appendChild(el);

      setTimeout(()=>{ if(el.isConnected) el.remove(); }, 5200);
    }

    // ---------- Tabs ----------
    const TAB_DEFS = [
      { id:"intro",  label:"導入｜任務與劇情" },
      { id:"market", label:"市場規模｜TAM/SAM/SOM" },
      { id:"fit",    label:"Fit 階段｜Venn" },
      { id:"mvp",    label:"MVP 驗證｜實驗工作台" },
      { id:"pivot",  label:"轉向｜Pivot 儀表板" },
      { id:"cards",  label:"知識卡｜20 點" },
      { id:"export", label:"筆記與輸出" },
    ];

    // ---------- State (default) ----------
    const DEFAULT_STATE = {
      meta: {
        versionId: uid(),
        versionName: "未命名",
        createdAt: nowISO(),
        updatedAt: nowISO(),
      },
      ui: {
        activeTab: "intro",
        isHamburgerOpen: false,
      },
      progress: {
        tabStatus: {
          intro: "todo",
          market: "todo",
          fit: "todo",
          mvp: "todo",
          pivot: "todo",
          cards: "todo",
          export: "todo"
        }
      },
      notes: [],
      intro: {
        groupName: "",
        teamSize: 3,
        chosenDomain: "跑鞋",
        warmup: { q1:"", q2:"", q3:"", q4:"", short1:"" },
        timelineOpenedIds: []
      },
      market: {
        mode: "topdown", // topdown|bottomup
        miniAssumptions: {
          persona: "",
          freqUnit: "每週",
          freqValue: 1,
          price: 0,
          reachablePct: 30,
        },
        inputs: {
          // topdown
          population: 0,
          serviceablePct: 50,
          addressablePct: 30,
          annualSpend: 0,

          // bottomup
          baseCustomers: 0,
          baseConversionPct: 5,
          expansionMultiplier: 10,
          regionCount: 1,
        },
        sliders: { penetrationPct: 5, conversionPct: 3, retentionPct: 40 },
        results: { TAM:0, SAM:0, SOM:0, revenueYear:0 },
        snapshots: []
      },
      fit: {
        // Part2 才會完整實作
        vennOpened: {vp:false, gtm:false, bm:false},
        metricMatch: { placements:{}, score:null },
        scenarioQuiz: { answers:{}, score:null },
        diagnosis: { stagePrimary:"", stageSecondary:"", confidence:0, rationaleText:"" },
        snapshots: []
      },
      mvp: {},
      pivot: {},
      cards: {},
      export: {}
    };

    // ---------- Storage ----------
    const LS_KEY = "rikuou_mvp_pmf_v1";
    const LS_VERSIONS_KEY = "rikuou_mvp_pmf_versions_v1";

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(DEFAULT_STATE);
        const s = JSON.parse(raw);
        // merge defaults to avoid missing keys
        return deepMerge(structuredClone(DEFAULT_STATE), s);
      }catch(e){
        console.warn(e);
        return structuredClone(DEFAULT_STATE);
      }
    }

    function deepMerge(base, patch){
      if(typeof base !== "object" || base === null) return patch;
      const out = Array.isArray(base) ? base.slice() : {...base};
      if(typeof patch !== "object" || patch === null) return out;
      for(const k of Object.keys(patch)){
        if(k in out){
          out[k] = deepMerge(out[k], patch[k]);
        }else{
          out[k] = patch[k];
        }
      }
      return out;
    }

    let state = loadState();
    let saveTimer = null;

    function scheduleSave(){
      // debounce 800ms
      $("#saveDot").style.background = "var(--bau-yellow)";
      $("#saveLabel").textContent = "暫存中…";
      if(saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(()=>{
        saveNow();
      }, 800);
    }

    function saveNow(){
      try{
        state.meta.updatedAt = nowISO();
        localStorage.setItem(LS_KEY, JSON.stringify(state));
        $("#saveDot").style.background = "var(--bau-green)";
        $("#saveLabel").textContent = "已暫存";
      }catch(e){
        console.warn(e);
        $("#saveDot").style.background = "var(--bau-red)";
        $("#saveLabel").textContent = "暫存失敗";
        toast("本地暫存失敗（可能是瀏覽器空間不足）。請先下載 JSON 備份。", "bad");
      }
    }

    // Versions (keep last 5)
    function loadVersions(){
      try{
        const raw = localStorage.getItem(LS_VERSIONS_KEY);
        return raw ? JSON.parse(raw) : [];
      }catch(e){
        return [];
      }
    }
    function saveVersions(list){
      localStorage.setItem(LS_VERSIONS_KEY, JSON.stringify(list));
    }

    function saveAsVersion(){
      const name = prompt("請輸入版本名稱（例如：第1組-第一次）", state.meta.versionName || "未命名");
      if(name === null) return;
      const versions = loadVersions();
      const v = {
        versionId: uid(),
        versionName: (name || "未命名").trim() || "未命名",
        updatedAt: nowISO(),
        payload: state
      };
      versions.unshift(v);
      const trimmed = versions.slice(0,5);
      saveVersions(trimmed);

      // update current name
      state.meta.versionName = v.versionName;
      scheduleSave();
      renderAll();
      toast("已另存版本（最多保留 5 份）", "ok");
    }

    function restoreVersion(){
      const versions = loadVersions();
      if(!versions.length){
        toast("沒有可還原的版本。先按「另存版本」。", "warn");
        return;
      }
      const menu = versions.map((v,i)=>`${i+1}. ${v.versionName}（${new Date(v.updatedAt).toLocaleString("zh-Hant")}）`).join("\n");
      const pick = prompt("請輸入要還原的版本編號：\n\n" + menu, "1");
      if(pick === null) return;
      const idx = parseInt(pick,10)-1;
      if(!isFinite(idx) || idx<0 || idx>=versions.length){
        toast("編號無效。", "warn");
        return;
      }
      const payload = versions[idx].payload;
      // hard restore + merge defaults
      state = deepMerge(structuredClone(DEFAULT_STATE), payload);
      saveNow();
      renderAll();
      toast("已還原版本。", "ok");
    }

    // ---------- Progress helpers ----------
    const STATUS_LABEL = { todo:"未開始", go:"進行中", done:"完成" };

    function setTabStatus(tabId, status){
      state.progress.tabStatus[tabId] = status;
      scheduleSave();
      renderProgress();
    }

    function computeIntroCompletion(){
      const w = state.intro.warmup;
      const answered = [w.q1,w.q2,w.q3,w.q4].filter(Boolean).length;
      const shortLen = (w.short1||"").trim().length;
      const hasSetup = (state.intro.groupName||"").trim().length>0 && Number(state.intro.teamSize)>0;
      const pass = (answered>=3) && (shortLen>=30) && hasSetup;
      return { answered, shortLen, hasSetup, pass };
    }

    function computeMarketCompletion(){
      const s = state.market;
      const mini = s.miniAssumptions;
      const okMini = (mini.persona||"").trim().length>=6
        && Number(mini.freqValue)>0
        && Number(mini.price)>0
        && Number(mini.reachablePct)>0;
      const hasSnap = (s.snapshots||[]).length>=1;
      const pass = okMini && hasSnap;
      return { okMini, hasSnap, pass };
    }

    function autoUpdateProgress(){
      const intro = computeIntroCompletion();
      if(intro.pass) setTabStatus("intro","done");
      else if(intro.answered>0 || intro.shortLen>0 || intro.hasSetup) setTabStatus("intro","go");
      else setTabStatus("intro","todo");

      const market = computeMarketCompletion();
      if(market.pass) setTabStatus("market","done");
      else if(market.okMini || market.hasSnap) setTabStatus("market","go");
      else setTabStatus("market","todo");

      // other tabs will be updated in Part 2+
    }

    // ---------- Render skeleton ----------
    function renderAll(){
      renderTabs();
      renderProgress();
      renderNotes();
      renderMain();
      $("#versionNamePill").textContent = "版本：" + (state.meta.versionName || "未命名");
    }

    function renderTabs(){
      const tabsEl = $("#tabs");
      const drawerTabsEl = $("#drawerTabs");
      tabsEl.innerHTML = "";
      drawerTabsEl.innerHTML = "";

      TAB_DEFS.forEach(t=>{
        const b = document.createElement("button");
        b.className = "tab" + (state.ui.activeTab===t.id ? " active":"");
        b.textContent = t.label;
        b.onclick = ()=>{ navigate(t.id); };
        tabsEl.appendChild(b);

        const b2 = document.createElement("button");
        b2.className = "tab" + (state.ui.activeTab===t.id ? " active":"");
        b2.textContent = t.label;
        b2.onclick = ()=>{ navigate(t.id); closeDrawer(); };
        drawerTabsEl.appendChild(b2);
      });
    }

    function renderProgress(){
      const el = $("#progressList");
      el.innerHTML = "";
      TAB_DEFS.forEach(t=>{
        const status = state.progress.tabStatus[t.id] || "todo";
        const row = document.createElement("div");
        row.className = "pitem";
        const left = document.createElement("div");
        left.className = "name";
        left.textContent = t.label;

        const right = document.createElement("div");
        right.className = "badge " + status;
        right.textContent = STATUS_LABEL[status] || status;

        row.appendChild(left);
        row.appendChild(right);
        row.onclick = ()=> navigate(t.id);
        el.appendChild(row);
      });
    }

    function renderNotes(){
      const el = $("#notesList");
      el.innerHTML = "";

      if(!state.notes.length){
        const empty = document.createElement("div");
        empty.className = "small-muted";
        empty.style.marginTop = "10px";
        empty.textContent = "尚無筆記。可按「＋新增」或在知識卡上按「加入筆記」。";
        el.appendChild(empty);
        return;
      }

      // stable sort by order then updatedAt
      const notes = state.notes.slice().sort((a,b)=>{
        const ao = (a.order ?? 999999);
        const bo = (b.order ?? 999999);
        if(ao !== bo) return ao - bo;
        return (b.updatedAt||"").localeCompare(a.updatedAt||"");
      });

      for(const n of notes){
        const box = document.createElement("div");
        box.className = "note";
        box.draggable = true;

        box.ondragstart = (e)=>{
          e.dataTransfer.setData("text/noteId", n.id);
          e.dataTransfer.effectAllowed = "move";
        };
        box.ondragover = (e)=>{ e.preventDefault(); };
        box.ondrop = (e)=>{
          e.preventDefault();
          const fromId = e.dataTransfer.getData("text/noteId");
          if(!fromId || fromId===n.id) return;
          reorderNotes(fromId, n.id);
        };

        const top = document.createElement("div");
        top.className = "note-top";

        const title = document.createElement("p");
        title.className = "note-title";
        title.textContent = n.title?.trim() ? n.title : "（未命名筆記）";

        const meta = document.createElement("div");
        meta.className = "note-meta";
        const t = new Date(n.updatedAt || n.createdAt).toLocaleString("zh-Hant");
        meta.textContent = `${tabLabel(n.tab)}｜${t}`;

        top.appendChild(title);
        top.appendChild(meta);

        const content = document.createElement("div");
        content.className = "note-content";
        content.textContent = n.content || "";

        const actions = document.createElement("div");
        actions.className = "note-actions";

        const editBtn = mkBtn("編輯", ()=> editNote(n.id), "small");
        const delBtn = mkBtn("刪除", ()=> deleteNote(n.id), "small danger");
        const snapBtn = mkBtn("插入快照", ()=> insertSnapshotToNote(n.id), "small");

        actions.appendChild(editBtn);
        actions.appendChild(snapBtn);
        actions.appendChild(delBtn);

        box.appendChild(top);
        box.appendChild(content);
        box.appendChild(actions);
        el.appendChild(box);
      }
    }

    function tabLabel(id){
      const t = TAB_DEFS.find(x=>x.id===id);
      return t ? t.label.split("｜")[0] : "未知";
    }

    function mkBtn(text, onClick, cls=""){
      const b = document.createElement("button");
      b.className = "btn " + (cls||"");
      b.textContent = text;
      b.onclick = onClick;
      return b;
    }

    function reorderNotes(fromId, toId){
      const notes = state.notes;
      const fromIdx = notes.findIndex(x=>x.id===fromId);
      const toIdx = notes.findIndex(x=>x.id===toId);
      if(fromIdx<0 || toIdx<0) return;
      const [moved] = notes.splice(fromIdx,1);
      notes.splice(toIdx,0,moved);
      // rewrite order
      notes.forEach((n,i)=> n.order = i);
      scheduleSave();
      renderNotes();
      toast("已重新排序筆記（可拖曳）。","ok");
    }

    function addNote(prefill={}){
      const n = {
        id: uid(),
        createdAt: nowISO(),
        updatedAt: nowISO(),
        tab: state.ui.activeTab,
        title: prefill.title || "",
        content: prefill.content || "",
        tags: prefill.tags || [],
        pinned: false,
        order: state.notes.length
      };
      state.notes.push(n);
      scheduleSave();
      renderNotes();
      editNote(n.id, true);
    }

    function editNote(noteId, forceOpen=false){
      const n = state.notes.find(x=>x.id===noteId);
      if(!n) return;
      const title = prompt("筆記標題（可留空）", n.title || "");
      if(title === null && !forceOpen) return;
      if(title !== null) n.title = title;

      const content = prompt("筆記內容（可用換行）", n.content || "");
      if(content === null && !forceOpen) return;
      if(content !== null) n.content = content;

      n.updatedAt = nowISO();
      scheduleSave();
      renderNotes();
      toast("已更新筆記。","ok");
    }

    function deleteNote(noteId){
      const idx = state.notes.findIndex(x=>x.id===noteId);
      if(idx<0) return;
      if(!confirm("確定刪除這則筆記？")) return;
      state.notes.splice(idx,1);
      state.notes.forEach((n,i)=> n.order = i);
      scheduleSave();
      renderNotes();
      toast("已刪除筆記。","ok");
    }

    function insertSnapshotToNote(noteId){
      const n = state.notes.find(x=>x.id===noteId);
      if(!n) return;

      const tab = state.ui.activeTab;
      let snippet = "";
      if(tab === "market"){
        const s = state.market;
        snippet = buildMarketSnapshotText(s.results, s.miniAssumptions, s.sliders);
      }else if(tab === "intro"){
        snippet = buildIntroSnapshotText();
      }else{
        snippet = `【快照】目前頁籤：${tabLabel(tab)}\n（此頁籤的詳細快照將在下一段程式加入）`;
      }

      n.content = (n.content ? (n.content + "\n\n") : "") + snippet;
      n.updatedAt = nowISO();
      scheduleSave();
      renderNotes();
      toast("已插入快照到筆記。","ok");
    }

    function buildIntroSnapshotText(){
      const w = state.intro.warmup;
      return [
        "【快照｜導入】",
        `小組：${state.intro.groupName || "未填"}｜人數：${state.intro.teamSize || "未填"}｜主題：${state.intro.chosenDomain || "未選"}`,
        `熱身 Q1～Q4：${[w.q1,w.q2,w.q3,w.q4].filter(Boolean).length}/4 已作答`,
        `簡答：${(w.short1||"").trim().slice(0,120)}${(w.short1||"").trim().length>120 ? "…" : ""}`
      ].join("\n");
    }

    function buildMarketSnapshotText(results, mini, sliders){
      return [
        "【快照｜市場規模】",
        `族群：${mini.persona || "未填"}`,
        `頻率：${mini.freqUnit}${mini.freqValue} 次｜願付：${mini.price}｜可觸及：${mini.reachablePct}%`,
        `拉桿：滲透${sliders.penetrationPct}%｜轉換${sliders.conversionPct}%｜留存${sliders.retentionPct}%`,
        `TAM：${formatMoney(results.TAM)}｜SAM：${formatMoney(results.SAM)}｜SOM：${formatMoney(results.SOM)}`,
        `年收入估計：${formatMoney(results.revenueYear)}`
      ].join("\n");
    }

    // ---------- Navigation ----------
    function navigate(tabId){
      state.ui.activeTab = tabId;
      scheduleSave();
      autoUpdateProgress();
      renderTabs();
      renderMain();
      // scroll to top of main
      window.scrollTo({top: 0, behavior:"smooth"});
    }

    function openDrawer(){
      $("#drawer").classList.add("open");
      state.ui.isHamburgerOpen = true;
    }
    function closeDrawer(){
      $("#drawer").classList.remove("open");
      state.ui.isHamburgerOpen = false;
    }

    // ---------- Main render ----------
    function renderMain(){
      const main = $("#main");
      main.innerHTML = "";

      if(state.ui.activeTab === "intro"){
        main.appendChild(renderIntroTab());
      }else if(state.ui.activeTab === "market"){
        main.appendChild(renderMarketTab());
      }else{
        main.appendChild(renderPlaceholderTab(state.ui.activeTab));
      }
    }

    function renderPlaceholderTab(tabId){
      const p = document.createElement("div");
      p.className = "panel";
      const t = TAB_DEFS.find(x=>x.id===tabId);
      p.innerHTML = `
        <div class="hero">
          <div class="hero-badge"></div>
          <div>
            <h2 style="margin:0">${t ? t.label : "頁籤"}</h2>
            <p style="margin-top:8px">
              這個頁籤的互動元件（Venn、配對、卡片排序、轉向連結圖、知識卡牆、輸出）會在下一段 HTML（Part 2）加入。
              目前你仍可先用右側「筆記」記錄課堂討論內容。
            </p>
            <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn primary" id="goMarketBtn">先去做市場規模</button>
              <button class="btn" id="addNoteHereBtn">在這裡加一則筆記</button>
            </div>
          </div>
        </div>
      `;
      setTimeout(()=>{
        const g = $("#goMarketBtn");
        if(g) g.onclick = ()=> navigate("market");
        const a = $("#addNoteHereBtn");
        if(a) a.onclick = ()=> addNote({ title: `筆記｜${tabLabel(tabId)}`, content:"" });
      },0);
      return p;
    }

    // ---------- Tab 1: Intro ----------
    function renderIntroTab(){
      const wrap = document.createElement("div");

      // Hero
      const hero = document.createElement("div");
      hero.className = "panel";
      hero.innerHTML = `
        <div class="hero">
          <div class="hero-badge"></div>
          <div>
            <h2>你要完成的任務：把 MVP/PMF 做成可推進的決策</h2>
            <p>
              這堂課用《陸王》的故事當情境：把既有強項拿去解新需求，看起來合理，但最難的是——
              <b>你怎麼在資訊不足時，證明「真的有人要」</b>，以及「該不該轉向」。
            </p>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
              <button class="btn primary" id="introStartBtn">開始（展開故事與任務）</button>
              <button class="btn" id="introJumpMarketBtn">直接去市場規模</button>
            </div>
          </div>
        </div>
      `;
      wrap.appendChild(hero);

      // Deliverables
      const del = document.createElement("div");
      del.className = "panel";
      del.innerHTML = `
        <div class="section-title">
          <h3>四份成果（課後可下載）</h3>
          <div class="kicker"><span class="pill">建議小組共同完成</span></div>
        </div>
        <div class="grid2">
          <div class="card">
            <div style="display:flex; align-items:center; justify-content:space-between">
              <div style="font-weight:900">1) 市場規模估算</div>
              <span class="pill">TAM / SAM / SOM</span>
            </div>
            <div class="small-muted" style="margin-top:8px; line-height:1.6">
              用最小假設集估算市場，並看敏感度：哪個假設一改就會讓結果翻盤。
            </div>
          </div>
          <div class="card">
            <div style="display:flex; align-items:center; justify-content:space-between">
              <div style="font-weight:900">2) Fit 階段判讀</div>
              <span class="pill">VP / GTM / BM</span>
            </div>
            <div class="small-muted" style="margin-top:8px; line-height:1.6">
              你卡在「值不值得」？「賣不賣得動」？還是「能不能長久做」？用指標回答，不靠感覺。
            </div>
          </div>
          <div class="card">
            <div style="display:flex; align-items:center; justify-content:space-between">
              <div style="font-weight:900">3) MVP 實驗設計單</div>
              <span class="pill">門檻 + 停損</span>
            </div>
            <div class="small-muted" style="margin-top:8px; line-height:1.6">
              MVP 不是做產品，是做實驗：先挑最致命的不確定，設成功門檻與停損線。
            </div>
          </div>
          <div class="card">
            <div style="display:flex; align-items:center; justify-content:space-between">
              <div style="font-weight:900">4) 轉向決策與連結圖</div>
              <span class="pill">舊 → 新</span>
            </div>
            <div class="small-muted" style="margin-top:8px; line-height:1.6">
              轉向不是亂跳題：要能說清楚保留哪些已驗證部分、改掉哪些失敗假設。
            </div>
          </div>
        </div>
      `;
      wrap.appendChild(del);

      // Story & Timeline
      const story = document.createElement("div");
      story.className = "panel";
      story.innerHTML = `
        <div class="section-title">
          <h3>故事（3 分鐘版）＋關鍵節點</h3>
          <div class="kicker"><span class="pill">沒看過也能上手</span></div>
        </div>

        <div class="card">
          <div style="font-weight:900">三段摘要</div>
          <div class="small-muted" style="margin-top:8px; line-height:1.7">
            <b>背景：</b>一家傳統製造公司面臨壓力，既有產品的路越走越窄。<br/>
            <b>企圖：</b>他們想把既有技術轉用到跑鞋上，做出「薄底、像足袋感」的產品。<br/>
            <b>不確定：</b>市場真的要嗎？跑者願意付出代價（錢、時間、風險）去穿它訓練甚至比賽嗎？
          </div>
          <div class="small-muted" style="margin-top:10px">
            建議你把下面節點點開：每個節點都對應到一個「要被證明的假設」。
          </div>
        </div>

        <div class="timeline" id="timeline"></div>
      `;
      wrap.appendChild(story);

      // Warmup quiz
      const quiz = document.createElement("div");
      quiz.className = "panel";
      quiz.innerHTML = `
        <div class="section-title">
          <h3>熱身題（理解情境）</h3>
          <div class="kicker"><span class="pill">4 題單選 + 1 題簡答</span></div>
        </div>
        <div class="quiz" id="warmupQuiz"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
          <button class="btn primary" id="introCheckBtn">檢查完成度</button>
          <button class="btn" id="introAddSnapshotNoteBtn">把導入快照加入筆記</button>
        </div>
      `;
      wrap.appendChild(quiz);

      // Group setup
      const setup = document.createElement("div");
      setup.className = "panel";
      setup.innerHTML = `
        <div class="section-title">
          <h3>小組設定</h3>
          <div class="kicker"><span class="pill">建議先填</span></div>
        </div>

        <div class="row">
          <div class="col">
            <div class="field">
              <label>小組名稱（必填）</label>
              <input class="input" id="groupName" placeholder="例如：第2組／Alpha" />
              <div class="hint">用來標記你下載的成果檔。</div>
            </div>
          </div>

          <div class="col">
            <div class="field">
              <label>小組人數</label>
              <select id="teamSize">
                <option value="1">1</option><option value="2">2</option><option value="3">3</option>
                <option value="4">4</option><option value="5">5</option><option value="6">6</option>
              </select>
              <div class="hint">建議 3–5 人。</div>
            </div>
          </div>

          <div class="col">
            <div class="field">
              <label>本次討論主題（可先用預設）</label>
              <select id="chosenDomain">
                <option value="跑鞋">跑鞋</option>
                <option value="餐飲">餐飲</option>
                <option value="平台服務">平台服務</option>
                <option value="校園活動">校園活動</option>
                <option value="其他">其他（先用筆記補充）</option>
              </select>
              <div class="hint">主題只是練習載體，重點是決策方法。</div>
            </div>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
          <button class="btn primary" id="introSaveSetupBtn">儲存設定</button>
          <button class="btn" id="introGoMarketBtn2">前往市場規模</button>
        </div>
      `;
      wrap.appendChild(setup);

      // After mount: bind events and build quiz/timeline
      setTimeout(()=>{
        $("#introStartBtn").onclick = ()=>{
          toast("已展開導入內容。你可以先點故事節點，再做熱身題。","ok");
          navigate("intro");
        };
        $("#introJumpMarketBtn").onclick = ()=> navigate("market");

        // Timeline data
        const TL = [
          {
            id:"tl1",
            title:"起念頭：把既有強項用在跑鞋",
            body:"他們不是完全重做一套技術，而是把既有強項轉用到新需求上。聽起來合理，但下一步必須證明：跑者真的要、而且願意付出代價。"
          },
          {
            id:"tl2",
            title:"需求洞察：跑者的受傷與訓練方式",
            body:"故事裡談到跑者受傷與鞋底厚薄、著地方式等問題。這對應到：你要先講清楚『誰的什麼痛』，再談你要怎麼減痛。"
          },
          {
            id:"tl3",
            title:"版本迭代：不是做一個版本就好",
            body:"引入專家、調整鞋底與腳型差異，代表：版本不是浪費，是比較工具。沒有比較就很難學到『哪個假設比較像真的』。"
          },
          {
            id:"tl4",
            title:"測試場景：要用什麼訊號算成功？",
            body:"當測試走向更高風險場景（訓練/比賽），你需要更清楚的成功門檻與停損線，避免『越做越捨不得停』。"
          }
        ];
        const tlEl = $("#timeline");
        tlEl.innerHTML = "";
        TL.forEach(item=>{
          const it = document.createElement("div");
          it.className = "tl-item" + (state.intro.timelineOpenedIds.includes(item.id) ? " open" : "");
          it.innerHTML = `
            <div class="tl-head">
              <div class="tl-title"><span class="tl-dot"></span>${item.title}</div>
              <div class="pill">點開</div>
            </div>
            <div class="tl-body">${item.body}</div>
          `;
          it.onclick = ()=>{
            it.classList.toggle("open");
            const opened = it.classList.contains("open");
            const arr = state.intro.timelineOpenedIds;
            const idx = arr.indexOf(item.id);
            if(opened && idx<0) arr.push(item.id);
            if(!opened && idx>=0) arr.splice(idx,1);
            scheduleSave();
          };
          tlEl.appendChild(it);
        });

        // Warmup quiz data
        const warmup = [
          {
            id:"q1",
            title:"Q1（單選）《陸王》故事的核心不確定，最接近哪一種？",
            type:"single",
            options:{
              A:"公司能不能把產品做得更漂亮",
              B:"市場會不會真的願意買「薄底、像足袋感」的跑鞋",
              C:"只要找代言人就一定會成功",
              D:"只要成本降下來就一定會成功",
            },
            answer:"B",
            feedback:"不是「能不能做」，而是「有人要不要」與「要不要到願意付代價」。"
          },
          {
            id:"q2",
            title:"Q2（單選）把地下足袋技術做成跑鞋，最像哪一種做法？",
            type:"single",
            options:{
              A:"完全重新發明一套技術",
              B:"把既有強項用在新需求，想證明它能成立",
              C:"先做廣告再想產品",
              D:"先把工廠擴大再找客人",
            },
            answer:"B",
            feedback:"這是「強項轉用」；但仍需用測試證明需求與付費。"
          },
          {
            id:"q3",
            title:"Q3（單選）如果你只能用一句話說明 MVP，哪一句最貼近？",
            type:"single",
            options:{
              A:"先把產品做完整再上線",
              B:"做最便宜的版本",
              C:"用最小投入換到最重要的學習",
              D:"先做一堆功能讓人選",
            },
            answer:"C",
            feedback:"MVP 的目的是學習，不是省錢或偷工。"
          },
          {
            id:"q4",
            title:"Q4（單選）要先做 TAM/SAM/SOM 的原因是？",
            type:"single",
            options:{
              A:"看起來比較像在做報告",
              B:"先確認「你要抓的那段市場」是不是小到不值得做",
              C:"只要寫大一點就會有人買單",
              D:"方便把競爭者全部列出來",
            },
            answer:"B",
            feedback:"市場估算是用來檢查方向與假設，不是裝飾。"
          }
        ];
        const quizEl = $("#warmupQuiz");
        quizEl.innerHTML = "";
        warmup.forEach(q=>{
          const box = document.createElement("div");
          box.className = "q";
          box.innerHTML = `
            <div class="q-title">${q.title}</div>
            <div class="opts" id="opts_${q.id}"></div>
            <div class="feedback">回饋：${q.feedback}</div>
          `;
          const optsEl = $("#opts_"+q.id, box);
          Object.entries(q.options).forEach(([k,v])=>{
            const opt = document.createElement("label");
            opt.className = "opt";
            opt.innerHTML = `
              <input type="radio" name="${q.id}" value="${k}" />
              <div><b>${k}.</b> ${v}</div>
            `;
            opt.onclick = (e)=>{
              // allow label click
              const input = $("input", opt);
              input.checked = true;
              state.intro.warmup[q.id] = k;
              box.classList.add("show-feedback");

              // mark
              $$(".opt", box).forEach(x=>x.classList.remove("correct","wrong"));
              opt.classList.add(k===q.answer ? "correct":"wrong");
              scheduleSave();
              autoUpdateProgress();
              renderProgress();
            };
            optsEl.appendChild(opt);
          });
          // restore selection
          const chosen = state.intro.warmup[q.id];
          if(chosen){
            const input = $(`input[value="${chosen}"]`, box);
            if(input){
              input.checked = true;
              box.classList.add("show-feedback");
              const optEl = input.closest(".opt");
              optEl.classList.add(chosen===q.answer ? "correct":"wrong");
            }
          }
          quizEl.appendChild(box);
        });

        // Short answer
        const shortQ = document.createElement("div");
        shortQ.className = "q";
        shortQ.innerHTML = `
          <div class="q-title">Q5（簡答，30–80字）如果你是《陸王》團隊，你覺得第一個要被證明的事情是什麼？為什麼？</div>
          <div class="hint">建議寫法：誰（目標族群）＋什麼情境＋願不願意（付代價/改習慣/承擔風險）＋你打算看什麼訊號。</div>
          <div class="field" style="margin-top:10px">
            <textarea id="warmupShort" placeholder="例：『常跑全馬的跑者，在訓練時願意改穿薄底鞋，因為…；我會看…（例如：試用後回訪、願意預購、願意帶去訓練）』"></textarea>
            <div class="hint" id="shortCount">0 字</div>
          </div>
        `;
        quizEl.appendChild(shortQ);

        const ta = $("#warmupShort");
        ta.value = state.intro.warmup.short1 || "";
        const countEl = $("#shortCount");
        const updateCount = ()=>{
          const len = (ta.value||"").trim().length;
          countEl.textContent = `${len} 字` + (len<30 ? "（至少 30 字）" : "");
        };
        updateCount();
        ta.addEventListener("input", ()=>{
          state.intro.warmup.short1 = ta.value;
          updateCount();
          scheduleSave();
          autoUpdateProgress();
        });

        // Setup restore
        $("#groupName").value = state.intro.groupName || "";
        $("#teamSize").value = String(state.intro.teamSize || 3);
        $("#chosenDomain").value = state.intro.chosenDomain || "跑鞋";

        $("#introSaveSetupBtn").onclick = ()=>{
          state.intro.groupName = $("#groupName").value;
          state.intro.teamSize = parseInt($("#teamSize").value,10) || 3;
          state.intro.chosenDomain = $("#chosenDomain").value;
          scheduleSave();
          autoUpdateProgress();
          toast("已儲存小組設定。","ok");
        };
        $("#introGoMarketBtn2").onclick = ()=>{
          state.intro.groupName = $("#groupName").value;
          state.intro.teamSize = parseInt($("#teamSize").value,10) || 3;
          state.intro.chosenDomain = $("#chosenDomain").value;
          scheduleSave();
          autoUpdateProgress();
          navigate("market");
        };

        $("#introCheckBtn").onclick = ()=>{
          const c = computeIntroCompletion();
          if(c.pass) toast("導入完成：熱身題與小組設定已達建議門檻。","ok");
          else{
            const miss = [];
            if(!c.hasSetup) miss.push("小組名稱/人數");
            if(c.answered<3) miss.push("單選題至少 3 題");
            if(c.shortLen<30) miss.push("簡答至少 30 字");
            toast("尚未完成：" + miss.join("、"), "warn");
          }
          autoUpdateProgress();
          renderProgress();
        };

        $("#introAddSnapshotNoteBtn").onclick = ()=>{
          addNote({
            title: "快照｜導入",
            content: buildIntroSnapshotText(),
            tags: ["導入","課堂"]
          });
        };

        // also wire top-level quick buttons
        $("#introAddSnapshotNoteBtn").onclick = ()=>{
          addNote({ title:"快照｜導入", content: buildIntroSnapshotText() });
        };
      },0);

      return wrap;
    }

    // ---------- Tab 2: Market ----------
    function renderMarketTab(){
      const wrap = document.createElement("div");

      const hero = document.createElement("div");
      hero.className = "panel";
      hero.innerHTML = `
        <div class="hero">
          <div class="hero-badge"></div>
          <div>
            <h2>市場規模：用最小假設集估 TAM / SAM / SOM</h2>
            <p>
              你不需要一開始就算得很準。你需要的是：把假設寫清楚、看敏感度，
              找出「哪個假設最該先驗證」，避免忙很久仍不知道方向對不對。
            </p>
            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
              <button class="btn primary" id="lockSnapshotBtn">鎖定本次估算（生成快照）</button>
              <button class="btn" id="marketAddSnapshotNoteBtn">把市場快照加入筆記</button>
            </div>
          </div>
        </div>
      `;
      wrap.appendChild(hero);

      const panel = document.createElement("div");
      panel.className = "panel";
      panel.innerHTML = `
        <div class="section-title">
          <h3>估算路徑</h3>
          <div class="kicker"><span class="pill">可切換</span></div>
        </div>

        <div class="mode-toggle" id="modeToggle"></div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:900">最小假設集（必填）</div>
          <div class="small-muted" style="margin-top:8px; line-height:1.6">
            先把「誰、多久一次、願意付多少、你碰得到多少」寫清楚。算式才有意義。
          </div>

          <div class="row" style="margin-top:10px">
            <div class="col">
              <div class="field">
                <label>目標族群描述（至少 6 字）</label>
                <input class="input" id="ma_persona" placeholder="例如：每週跑步 2 次以上的入門跑者" />
                <div class="hint">寫清楚情境，比寫年齡更重要。</div>
              </div>
            </div>

            <div class="col">
              <div class="field">
                <label>使用頻率</label>
                <div class="row" style="gap:8px">
                  <select id="ma_freqUnit" style="flex:1 1 120px">
                    <option value="每天">每天</option>
                    <option value="每週">每週</option>
                    <option value="每月">每月</option>
                    <option value="每年">每年</option>
                  </select>
                  <input class="input" id="ma_freqValue" type="number" min="1" step="1" style="flex:1 1 120px" />
                </div>
                <div class="hint">例：每週 2 次。</div>
              </div>
            </div>

            <div class="col">
              <div class="field">
                <label>願付價格（或等價成本）</label>
                <input class="input" id="ma_price" type="number" min="0" step="1" placeholder="例如：2500" />
                <div class="hint">若是免費服務，可用「願意投入的時間/風險」換算。</div>
              </div>
            </div>

            <div class="col">
              <div class="field">
                <label>可觸及比例（%）</label>
                <input class="input" id="ma_reachablePct" type="number" min="0" max="100" step="1" />
                <div class="hint">你真的碰得到的那段（不是全世界）。</div>
              </div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:900">計算器</div>
          <div class="small-muted" style="margin-top:8px; line-height:1.6">
            你可以用「由上而下」或「由下而上」。兩者沒有誰比較高級，重點是把假設與推理寫清楚。
          </div>

          <div class="row" style="margin-top:10px" id="calcFields"></div>

          <div class="result-strip" id="resultStrip"></div>

          <div class="sliders" id="sliders"></div>

          <div class="canvas-wrap">
            <div style="font-weight:900">函數圖（即時更新）</div>
            <div class="small-muted" style="margin-top:6px; line-height:1.6">
              圖 A：年收入估計（依客數/客單/頻率）｜圖 B：SOM 隨轉換率變動（其他假設固定）
            </div>
            <canvas id="plotA" height="220"></canvas>
            <div class="plot-caption">圖 A：收入曲線（示意）</div>
            <canvas id="plotB" height="220" style="margin-top:12px"></canvas>
            <div class="plot-caption">圖 B：SOM-轉換率曲線（示意）</div>
          </div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
            <button class="btn" id="marketCheckBtn">檢查完成度</button>
            <button class="btn" id="marketNextBtn">下一步：Fit 階段</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:900">快照列表</div>
          <div class="small-muted" style="margin-top:8px; line-height:1.6">
            你可以生成多份快照，用來比較不同假設設定。最多保留在本地版本內。
          </div>
          <div id="snapshotList" style="display:grid; gap:10px; margin-top:10px"></div>
        </div>
      `;
      wrap.appendChild(panel);

      setTimeout(()=>{
        // Mode toggle
        const toggleEl = $("#modeToggle");
        toggleEl.innerHTML = "";
        const modes = [
          { id:"topdown", label:"由上而下（切層估算）" },
          { id:"bottomup", label:"由下而上（單點外推）" }
        ];
        modes.forEach(m=>{
          const b = document.createElement("button");
          b.className = "mode-btn" + (state.market.mode===m.id ? " active":"");
          b.textContent = m.label;
          b.onclick = ()=>{
            state.market.mode = m.id;
            scheduleSave();
            renderMain(); // rerender tab
          };
          toggleEl.appendChild(b);
        });

        // Mini assumptions bind
        $("#ma_persona").value = state.market.miniAssumptions.persona || "";
        $("#ma_freqUnit").value = state.market.miniAssumptions.freqUnit || "每週";
        $("#ma_freqValue").value = state.market.miniAssumptions.freqValue ?? 1;
        $("#ma_price").value = state.market.miniAssumptions.price ?? 0;
        $("#ma_reachablePct").value = state.market.miniAssumptions.reachablePct ?? 30;

        ["ma_persona","ma_freqUnit","ma_freqValue","ma_price","ma_reachablePct"].forEach(id=>{
          $("#"+id).addEventListener("input", ()=>{
            state.market.miniAssumptions.persona = $("#ma_persona").value;
            state.market.miniAssumptions.freqUnit = $("#ma_freqUnit").value;
            state.market.miniAssumptions.freqValue = parseFloat($("#ma_freqValue").value) || 0;
            state.market.miniAssumptions.price = parseFloat($("#ma_price").value) || 0;
            state.market.miniAssumptions.reachablePct = clamp(parseFloat($("#ma_reachablePct").value) || 0, 0, 100);
            scheduleSave();
            recomputeMarket();
            autoUpdateProgress();
          });
        });

        // Calculator fields
        const fieldsEl = $("#calcFields");
        fieldsEl.innerHTML = "";
        if(state.market.mode === "topdown"){
          fieldsEl.innerHTML = `
            <div class="col">
              <div class="field">
                <label>總體規模（人數或企業數）</label>
                <input class="input" id="in_population" type="number" min="0" step="1" placeholder="例如：500000" />
                <div class="hint">先抓一個合理級距即可。</div>
              </div>
            </div>

            <div class="col">
              <div class="field">
                <label>可服務比例（%）</label>
                <input class="input" id="in_serviceablePct" type="number" min="0" max="100" step="1" />
                <div class="hint">例如：有運動習慣的人。</div>
              </div>
            </div>

            <div class="col">
              <div class="field">
                <label>可成交比例（%）</label>
                <input class="input" id="in_addressablePct" type="number" min="0" max="100" step="1" />
                <div class="hint">例如：你真的能接觸到、也願意考慮的人。</div>
              </div>
            </div>

            <div class="col">
              <div class="field">
                <label>年消費（或年價值）</label>
                <input class="input" id="in_annualSpend" type="number" min="0" step="1" placeholder="例如：3000" />
                <div class="hint">若是非付費服務，可換成每年等價投入。</div>
              </div>
            </div>
          `;
        }else{
          fieldsEl.innerHTML = `
            <div class="col">
              <div class="field">
                <label>單點場景客數（一次能接觸的人）</label>
                <input class="input" id="in_baseCustomers" type="number" min="0" step="1" placeholder="例如：500" />
                <div class="hint">例如：一個社團、一次活動、一個校園場域。</div>
              </div>
            </div>

            <div class="col">
              <div class="field">
                <label>單點成交率（%）</label>
                <input class="input" id="in_baseConversionPct" type="number" min="0" max="100" step="1" />
                <div class="hint">先抓保守值，避免自嗨。</div>
              </div>
            </div>

            <div class="col">
              <div class="field">
                <label>可擴張倍數</label>
                <input class="input" id="in_expansionMultiplier" type="number" min="0" step="1" />
                <div class="hint">例如：從一個系擴到全校、再到多校。</div>
              </div>
            </div>

            <div class="col">
              <div class="field">
                <label>可觸及地區/單位數</label>
                <input class="input" id="in_regionCount" type="number" min="1" step="1" />
                <div class="hint">例如：可覆蓋幾個校園或場域。</div>
              </div>
            </div>
          `;
        }

        // Restore calc inputs + bind
        const bindNum = (id, key)=>{
          const el = $("#"+id);
          if(!el) return;
          el.value = state.market.inputs[key] ?? 0;
          el.addEventListener("input", ()=>{
            state.market.inputs[key] = parseFloat(el.value) || 0;
            scheduleSave();
            recomputeMarket();
          });
        };

        if(state.market.mode === "topdown"){
          bindNum("in_population","population");
          bindNum("in_serviceablePct","serviceablePct");
          bindNum("in_addressablePct","addressablePct");
          bindNum("in_annualSpend","annualSpend");
        }else{
          bindNum("in_baseCustomers","baseCustomers");
          bindNum("in_baseConversionPct","baseConversionPct");
          bindNum("in_expansionMultiplier","expansionMultiplier");
          bindNum("in_regionCount","regionCount");
        }

        // Sliders
        const slidersEl = $("#sliders");
        slidersEl.innerHTML = "";
        const sliderDefs = [
          { key:"penetrationPct", name:"滲透率", min:0, max:100, step:1 },
          { key:"conversionPct", name:"轉換率", min:0, max:100, step:1 },
          { key:"retentionPct", name:"留存率", min:0, max:100, step:1 },
        ];
        sliderDefs.forEach(sdef=>{
          const box = document.createElement("div");
          box.className = "slider";
          box.innerHTML = `
            <div class="slider-top">
              <div class="name">${sdef.name}</div>
              <div class="val" id="sv_${sdef.key}">—</div>
            </div>
            <input type="range" id="sr_${sdef.key}" min="${sdef.min}" max="${sdef.max}" step="${sdef.step}" />
            <div class="hint">調整後會影響 SOM 與收入估計。</div>
          `;
          slidersEl.appendChild(box);

          const r = $("#sr_"+sdef.key, box);
          const v = $("#sv_"+sdef.key, box);
          r.value = state.market.sliders[sdef.key] ?? 0;
          v.textContent = (state.market.sliders[sdef.key] ?? 0) + "%";
          r.addEventListener("input", ()=>{
            state.market.sliders[sdef.key] = parseFloat(r.value) || 0;
            v.textContent = (state.market.sliders[sdef.key] ?? 0) + "%";
            scheduleSave();
            recomputeMarket();
          });
        });

        // Result strip + plots
        renderMarketResults();
        recomputeMarket();

        // Buttons
        $("#lockSnapshotBtn").onclick = ()=>{
          const mini = state.market.miniAssumptions;
          if((mini.persona||"").trim().length<6 || Number(mini.freqValue)<=0 || Number(mini.price)<=0 || Number(mini.reachablePct)<=0){
            toast("先把「最小假設集」填完整再鎖定快照。","warn");
            return;
          }
          const snap = {
            id: uid(),
            createdAt: nowISO(),
            mode: state.market.mode,
            assumptions: structuredClone(state.market.miniAssumptions),
            inputs: structuredClone(state.market.inputs),
            sliders: structuredClone(state.market.sliders),
            results: structuredClone(state.market.results)
          };
          state.market.snapshots.unshift(snap);
          scheduleSave();
          renderSnapshots();
          autoUpdateProgress();
          toast("已生成快照（可用於比較）。","ok");
        };

        $("#marketAddSnapshotNoteBtn").onclick = ()=>{
          addNote({
            title: "快照｜市場規模",
            content: buildMarketSnapshotText(state.market.results, state.market.miniAssumptions, state.market.sliders)
          });
        };

        $("#marketCheckBtn").onclick = ()=>{
          const c = computeMarketCompletion();
          if(c.pass) toast("市場規模完成：已有快照，且最小假設集已填。","ok");
          else{
            const miss=[];
            if(!c.okMini) miss.push("最小假設集（族群/頻率/願付/可觸及）");
            if(!c.hasSnap) miss.push("至少 1 份快照");
            toast("尚未完成：" + miss.join("、"), "warn");
          }
          autoUpdateProgress();
          renderProgress();
        };

        $("#marketNextBtn").onclick = ()=> navigate("fit");

        renderSnapshots();
      },0);

      return wrap;
    }

    function renderMarketResults(){
      const strip = $("#resultStrip");
      strip.innerHTML = `
        <div class="metric">
          <div class="k">TAM（最大天花板）</div>
          <div class="v" id="v_TAM">—</div>
          <div class="s">把假設寫清楚比算很準更重要</div>
        </div>
        <div class="metric">
          <div class="k">SAM（你服務得到）</div>
          <div class="v" id="v_SAM">—</div>
          <div class="s">受通路/地區/限制影響</div>
        </div>
        <div class="metric">
          <div class="k">SOM（短期抓得到）</div>
          <div class="v" id="v_SOM">—</div>
          <div class="s">跟轉換率、滲透率很敏感</div>
        </div>
        <div class="metric">
          <div class="k">年收入估計（示意）</div>
          <div class="v" id="v_REV">—</div>
          <div class="s">用於看級距與敏感度</div>
        </div>
      `;
    }

    function recomputeMarket(){
      const s = state.market;
      const mini = s.miniAssumptions;
      const inputs = s.inputs;
      const sl = s.sliders;

      // Normalize mini assumptions
      const reachable = clamp(Number(mini.reachablePct)||0, 0, 100) / 100;
      const price = Number(mini.price)||0;

      // Frequency -> yearly multiplier (rough)
      const fUnit = mini.freqUnit;
      const fVal = Number(mini.freqValue)||0;
      let freqYear = 0;
      if(fUnit==="每天") freqYear = fVal * 365;
      else if(fUnit==="每週") freqYear = fVal * 52;
      else if(fUnit==="每月") freqYear = fVal * 12;
      else if(fUnit==="每年") freqYear = fVal * 1;
      else freqYear = fVal * 12;

      // Core percentages
      const penetration = clamp(Number(sl.penetrationPct)||0, 0, 100) / 100;
      const conversion = clamp(Number(sl.conversionPct)||0, 0, 100) / 100;
      const retention = clamp(Number(sl.retentionPct)||0, 0, 100) / 100;

      let TAM = 0, SAM = 0, SOM = 0;

      if(s.mode === "topdown"){
        const pop = Math.max(0, Number(inputs.population)||0);
        const serviceable = clamp(Number(inputs.serviceablePct)||0, 0, 100) / 100;
        const addressable = clamp(Number(inputs.addressablePct)||0, 0, 100) / 100;
        const annualSpend = Math.max(0, Number(inputs.annualSpend)||0);

        // interpret:
        // TAM = pop * annualSpend
        // SAM = pop * serviceable * annualSpend
        // SOM = pop * serviceable * addressable * reachable * penetration * conversion * annualSpend
        TAM = pop * annualSpend;
        SAM = pop * serviceable * annualSpend;
        SOM = pop * serviceable * addressable * reachable * penetration * conversion * annualSpend;
      }else{
        const baseCustomers = Math.max(0, Number(inputs.baseCustomers)||0);
        const baseConv = clamp(Number(inputs.baseConversionPct)||0, 0, 100) / 100;
        const mult = Math.max(0, Number(inputs.expansionMultiplier)||0);
        const region = Math.max(1, Number(inputs.regionCount)||1);

        // TAM as theoretical:
        // TAM = baseCustomers * mult * region * price * freqYear
        // SAM = TAM * reachable
        // SOM = SAM * penetration * conversion * retention * baseConv (base scenario quality)
        TAM = baseCustomers * mult * region * price * freqYear;
        SAM = TAM * reachable;
        SOM = SAM * penetration * conversion * retention * baseConv;
      }

      // Revenue estimate: assume SOM unit already in money (topdown uses annualSpend; bottomup uses price*freqYear)
      const revenueYear = SOM;

      s.results = { TAM, SAM, SOM, revenueYear };
      renderMarketNumbers();
      drawPlots();
      autoUpdateProgress();
      renderProgress();
    }

    function renderMarketNumbers(){
      const r = state.market.results;
      $("#v_TAM").textContent = formatMoney(r.TAM);
      $("#v_SAM").textContent = formatMoney(r.SAM);
      $("#v_SOM").textContent = formatMoney(r.SOM);
      $("#v_REV").textContent = formatMoney(r.revenueYear);
    }

    function drawPlots(){
      drawPlotA();
      drawPlotB();
    }

    function drawAxes(ctx, w, h, pad=28){
      ctx.clearRect(0,0,w,h);
      ctx.lineWidth = 1;
      ctx.strokeStyle = "rgba(17,24,39,.35)";
      // axes
      ctx.beginPath();
      ctx.moveTo(pad, 10);
      ctx.lineTo(pad, h-pad);
      ctx.lineTo(w-10, h-pad);
      ctx.stroke();

      // grid
      ctx.strokeStyle = "rgba(17,24,39,.10)";
      for(let i=1;i<=4;i++){
        const y = 10 + i*(h-pad-10)/5;
        ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(w-10, y); ctx.stroke();
      }
      for(let i=1;i<=6;i++){
        const x = pad + i*(w-pad-10)/7;
        ctx.beginPath(); ctx.moveTo(x, 10); ctx.lineTo(x, h-pad); ctx.stroke();
      }

      ctx.fillStyle = "rgba(17,24,39,.75)";
      ctx.font = "12px system-ui";
    }

    function drawPlotA(){
      const c = $("#plotA");
      const ctx = c.getContext("2d");
      const w = c.width = c.clientWidth * (window.devicePixelRatio||1);
      const h = c.height = 220 * (window.devicePixelRatio||1);

      const pad = 34*(window.devicePixelRatio||1);
      drawAxes(ctx, w, h, pad);

      // Plot: revenue as function of customers (0..N), using price & freq (simplified)
      const mini = state.market.miniAssumptions;
      const price = Number(mini.price)||0;
      const fUnit = mini.freqUnit;
      const fVal = Number(mini.freqValue)||0;
      let freqYear=0;
      if(fUnit==="每天") freqYear = fVal*365;
      else if(fUnit==="每週") freqYear = fVal*52;
      else if(fUnit==="每月") freqYear = fVal*12;
      else freqYear = fVal;

      const base = price * Math.max(freqYear, 1);
      const maxCustomers = 1000; // normalized
      const maxY = base * maxCustomers;

      // line
      ctx.strokeStyle = "rgba(37,99,235,.95)";
      ctx.lineWidth = 2*(window.devicePixelRatio||1);
      ctx.beginPath();
      for(let i=0;i<=60;i++){
        const xVal = maxCustomers * (i/60);
        const yVal = base * xVal;
        const x = pad + (w-pad-10) * (i/60);
        const y = (h-pad) - (h-pad-10) * (yVal / (maxY || 1));
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // label
      ctx.fillStyle = "rgba(17,24,39,.75)";
      ctx.font = `${12*(window.devicePixelRatio||1)}px system-ui`;
      ctx.fillText("客數 →", w - 120*(window.devicePixelRatio||1), h - 10*(window.devicePixelRatio||1));
      ctx.save();
      ctx.translate(12*(window.devicePixelRatio||1), 70*(window.devicePixelRatio||1));
      ctx.rotate(-Math.PI/2);
      ctx.fillText("收入 ↑", 0, 0);
      ctx.restore();
    }

    function drawPlotB(){
      const c = $("#plotB");
      const ctx = c.getContext("2d");
      const w = c.width = c.clientWidth * (window.devicePixelRatio||1);
      const h = c.height = 220 * (window.devicePixelRatio||1);

      const pad = 34*(window.devicePixelRatio||1);
      drawAxes(ctx, w, h, pad);

      // Plot SOM vs conversion 0..30% (display)
      const s = state.market;
      const mini = s.miniAssumptions;
      const inputs = s.inputs;
      const reachable = clamp(Number(mini.reachablePct)||0, 0, 100) / 100;
      const penetration = clamp(Number(s.sliders.penetrationPct)||0, 0, 100) / 100;
      const retention = clamp(Number(s.sliders.retentionPct)||0, 0, 100) / 100;

      let computeSOMFromConv = (conv)=>0;

      if(s.mode==="topdown"){
        const pop = Math.max(0, Number(inputs.population)||0);
        const serviceable = clamp(Number(inputs.serviceablePct)||0, 0, 100) / 100;
        const addressable = clamp(Number(inputs.addressablePct)||0, 0, 100) / 100;
        const annualSpend = Math.max(0, Number(inputs.annualSpend)||0);
        computeSOMFromConv = (conv)=>{
          return pop * serviceable * addressable * reachable * penetration * conv * annualSpend;
        };
      }else{
        const baseCustomers = Math.max(0, Number(inputs.baseCustomers)||0);
        const baseConv = clamp(Number(inputs.baseConversionPct)||0, 0, 100) / 100;
        const mult = Math.max(0, Number(inputs.expansionMultiplier)||0);
        const region = Math.max(1, Number(inputs.regionCount)||1);

        const price = Number(mini.price)||0;
        const fUnit = mini.freqUnit;
        const fVal = Number(mini.freqValue)||0;
        let freqYear=0;
        if(fUnit==="每天") freqYear = fVal*365;
        else if(fUnit==="每週") freqYear = fVal*52;
        else if(fUnit==="每月") freqYear = fVal*12;
        else freqYear = fVal;

        const TAM = baseCustomers * mult * region * price * freqYear;
        const SAM = TAM * reachable;
        computeSOMFromConv = (conv)=>{
          return SAM * penetration * conv * retention * baseConv;
        };
      }

      const maxConv = 0.30;
      let maxY = 0;
      for(let i=0;i<=60;i++){
        const conv = maxConv * (i/60);
        maxY = Math.max(maxY, computeSOMFromConv(conv));
      }

      ctx.strokeStyle = "rgba(245,158,11,.95)";
      ctx.lineWidth = 2*(window.devicePixelRatio||1);
      ctx.beginPath();
      for(let i=0;i<=60;i++){
        const conv = maxConv * (i/60);
        const yVal = computeSOMFromConv(conv);
        const x = pad + (w-pad-10) * (i/60);
        const y = (h-pad) - (h-pad-10) * (yVal / (maxY || 1));
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // marker at current conversion
      const curConv = clamp(Number(state.market.sliders.conversionPct)||0, 0, 100)/100;
      const xMark = pad + (w-pad-10) * (curConv / maxConv);
      const yMark = (h-pad) - (h-pad-10) * (computeSOMFromConv(curConv) / (maxY || 1));
      ctx.fillStyle = "rgba(225,29,72,.95)";
      ctx.beginPath();
      ctx.arc(xMark, yMark, 4*(window.devicePixelRatio||1), 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "rgba(17,24,39,.75)";
      ctx.font = `${12*(window.devicePixelRatio||1)}px system-ui`;
      ctx.fillText("轉換率 →", w - 140*(window.devicePixelRatio||1), h - 10*(window.devicePixelRatio||1));
      ctx.save();
      ctx.translate(12*(window.devicePixelRatio||1), 70*(window.devicePixelRatio||1));
      ctx.rotate(-Math.PI/2);
      ctx.fillText("SOM ↑", 0, 0);
      ctx.restore();
    }

    function renderSnapshots(){
      const list = $("#snapshotList");
      if(!list) return;
      list.innerHTML = "";
      const snaps = state.market.snapshots || [];
      if(!snaps.length){
        list.innerHTML = `<div class="small-muted">尚無快照。按「鎖定本次估算」即可生成。</div>`;
        return;
      }
      snaps.forEach((s,i)=>{
        const card = document.createElement("div");
        card.className = "card";
        const dt = new Date(s.createdAt).toLocaleString("zh-Hant");
        card.innerHTML = `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
            <div style="font-weight:900">快照 #${snaps.length - i}</div>
            <div class="pill">${dt}</div>
          </div>
          <div class="small-muted" style="margin-top:8px; line-height:1.6; white-space:pre-wrap">${buildMarketSnapshotText(s.results, s.assumptions, s.sliders)}</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
            <button class="btn small" data-act="apply" data-id="${s.id}">套用到目前設定</button>
            <button class="btn small" data-act="note" data-id="${s.id}">加入筆記</button>
            <button class="btn small danger" data-act="del" data-id="${s.id}">刪除</button>
          </div>
        `;
        list.appendChild(card);
      });

      $$("button[data-act]", list).forEach(b=>{
        b.onclick = ()=>{
          const id = b.getAttribute("data-id");
          const act = b.getAttribute("data-act");
          const snap = (state.market.snapshots||[]).find(x=>x.id===id);
          if(!snap) return;

          if(act==="apply"){
            state.market.mode = snap.mode;
            state.market.miniAssumptions = structuredClone(snap.assumptions);
            state.market.inputs = structuredClone(snap.inputs);
            state.market.sliders = structuredClone(snap.sliders);
            state.market.results = structuredClone(snap.results);
            scheduleSave();
            toast("已套用快照設定。","ok");
            renderMain();
          }
          if(act==="note"){
            addNote({
              title: "快照｜市場規模",
              content: buildMarketSnapshotText(snap.results, snap.assumptions, snap.sliders)
            });
          }
          if(act==="del"){
            if(!confirm("確定刪除這份快照？")) return;
            state.market.snapshots = state.market.snapshots.filter(x=>x.id!==id);
            scheduleSave();
            renderSnapshots();
            autoUpdateProgress();
            toast("已刪除快照。","ok");
          }
        };
      });
    }

    // ---------- Quick note buttons ----------
    $("#addNoteBtn").onclick = ()=> addNote({ title:"", content:"" });
    $("#quickNoteBtn").onclick = ()=> addNote({ title:"快速筆記", content:"" });

    // ---------- Drawer buttons ----------
    $("#hamburgerBtn").onclick = ()=> openDrawer();
    $("#drawerClose").onclick = ()=> closeDrawer();
    $("#drawer").addEventListener("click", (e)=>{
      if(e.target === $("#drawer")) closeDrawer();
    });

    // ---------- Version buttons ----------
    $("#saveAsBtn").onclick = ()=> saveAsVersion();
    $("#restoreBtn").onclick = ()=> restoreVersion();

    // ---------- Resize redraw plots ----------
    window.addEventListener("resize", ()=>{
      if(state.ui.activeTab==="market"){
        drawPlots();
      }
    });

    // ---------- Init ----------
    autoUpdateProgress();
    renderAll();
    toast("已載入：可離線使用、本地暫存、可下載（Part 1）。", "ok");
  </script>
</body>
</html>
<!-- =========================
PART 2 (貼入指引)
你已確認 Part 1 可運作，以下 Part 2 會「擴充同一份 HTML」：

A) 在 <style>...</style> 的結尾（</style> 之前）貼上「PART 2 CSS」
B) 在 <script>...</script> 的結尾（</script> 之前）貼上「PART 2 JS」
C) 需要把 Part 1 的 renderMain() 內的 else-if 加上一段 fit 分支（Part 2 JS 內已提供 replace 版）

========================= -->

<!-- =========================
A) PART 2 CSS（貼到 </style> 前）
========================= -->
<style>
  /* ===== PART 2: Fit Tab styles ===== */
  .venn-wrap{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: var(--shadow-inset);
    padding: 12px 12px;
  }
  .venn-top{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .venn-top .legend{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    align-items:center;
  }
  .venn-legend-item{
    display:flex; align-items:center; gap:8px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    font-size: var(--fz-xs);
    color: var(--muted);
    box-shadow: 6px 6px 14px rgba(17,24,39,.06), -6px -6px 14px rgba(255,255,255,.85);
    user-select:none;
  }
  .swatch{
    width: 10px; height: 10px; border-radius: 999px;
    box-shadow: 0 0 0 4px rgba(17,24,39,.06);
    flex:0 0 auto;
  }
  .swatch.vp{ background: rgba(245,158,11,.95); box-shadow: 0 0 0 4px rgba(245,158,11,.16); }
  .swatch.gtm{ background: rgba(37,99,235,.95); box-shadow: 0 0 0 4px rgba(37,99,235,.16); }
  .swatch.bm{ background: rgba(16,185,129,.95); box-shadow: 0 0 0 4px rgba(16,185,129,.16); }

  .venn-svg{
    width:100%;
    height: 320px;
    display:block;
    margin-top: 10px;
    border-radius: 18px;
    overflow:hidden;
  }
  .venn-note{
    margin-top: 10px;
    font-size: var(--fz-xs);
    color: var(--muted2);
    line-height: 1.5;
  }

  .bubble-card{
    margin-top: 10px;
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.08), -6px -6px 14px rgba(255,255,255,.85);
    padding: 12px 12px;
    display:none;
  }
  .bubble-card.show{ display:block; }
  .bubble-head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .bubble-title{ font-weight: 900; }
  .bubble-body{
    margin-top: 8px;
    color: var(--muted);
    font-size: var(--fz-sm);
    line-height: 1.6;
  }

  .drag-area{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 12px;
  }
  @media (max-width: 860px){
    .drag-area{ grid-template-columns: 1fr; }
  }

  .bank{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: var(--shadow-inset);
    padding: 12px 12px;
    min-height: 220px;
  }
  .bank h4{
    margin:0;
    font-size: var(--fz-h2);
  }
  .bank .small-muted{ margin-top:6px; }

  .draggables{
    display:flex;
    flex-wrap:wrap;
    gap: 10px;
    margin-top: 10px;
  }
  .metric-card{
    border-radius: 16px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.90);
    box-shadow: 6px 6px 14px rgba(17,24,39,.06), -6px -6px 14px rgba(255,255,255,.85);
    padding: 10px 10px;
    cursor: grab;
    user-select:none;
    font-size: var(--fz-sm);
    max-width: 100%;
  }
  .metric-card:active{ cursor: grabbing; }
  .metric-card .tag{
    display:inline-flex;
    align-items:center;
    gap:6px;
    font-size: var(--fz-xs);
    color: var(--muted2);
    margin-top:6px;
  }
  .metric-card .tag .mini{
    width:8px;height:8px;border-radius:999px;background: rgba(107,114,128,.55);
  }

  .dropzones{
    display:grid;
    gap: 10px;
    margin-top: 10px;
  }
  .zone{
    border-radius: 18px;
    border: 1px dashed rgba(107,114,128,.35);
    background: rgba(255,255,255,.90);
    box-shadow: 6px 6px 14px rgba(17,24,39,.05), -6px -6px 14px rgba(255,255,255,.80);
    padding: 10px 10px;
    min-height: 92px;
  }
  .zone.over{
    outline: 3px solid rgba(37,99,235,.14);
    border-color: rgba(37,99,235,.35);
  }
  .zone .zhead{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    margin-bottom: 8px;
  }
  .zone .ztitle{
    font-weight: 900;
    font-size: var(--fz-sm);
    display:flex;
    align-items:center;
    gap:8px;
  }
  .zone .zcount{
    font-size: var(--fz-xs);
    color: var(--muted2);
    white-space: nowrap;
  }
  .zone .zitems{
    display:flex;
    flex-wrap:wrap;
    gap: 8px;
  }
  .zitem{
    border-radius: 999px;
    padding: 6px 10px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.05), -6px -6px 14px rgba(255,255,255,.85);
    font-size: var(--fz-xs);
    cursor:pointer;
    user-select:none;
  }

  .scorebar{
    margin-top: 10px;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    justify-content:space-between;
  }
  .scorebox{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.06), -6px -6px 14px rgba(255,255,255,.85);
    padding: 10px 12px;
    min-width: 220px;
  }
  .scorebox .k{ font-size: var(--fz-xs); color: var(--muted); }
  .scorebox .v{ margin-top: 6px; font-weight: 900; font-size: 18px; }
  .scorebox .s{ margin-top: 4px; font-size: var(--fz-xs); color: var(--muted2); line-height:1.4; }

  .diag{
    margin-top: 12px;
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: var(--shadow-inset);
    padding: 12px 12px;
  }
  .diag .row{ margin-top: 8px; }
  .diag .k{
    font-size: var(--fz-xs);
    color: var(--muted);
  }
  .diag .big{
    margin-top: 6px;
    font-weight: 950;
    font-size: 18px;
  }

  .fit-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 12px;
  }
</style>

<!-- =========================
B) PART 2 JS（貼到 </script> 前）
========================= -->
<script>
  /* =========================
     PART 2: Fit tab implementation
     - Venn (SVG) + 3 bubble cards (<=200字)
     - 指標卡拖放配對（VP/GTM/BM）
     - 6 題情境題（含複選）
     - 診斷 + 快照 + 加入筆記
     ========================= */

  // ---------- PART 2: Extend progress logic ----------
  function computeFitCompletion(){
    const p = state.fit.metricMatch?.placements || {};
    const placedCount = Object.keys(p).length;
    const quizAns = state.fit.scenarioQuiz?.answers || {};
    const quizCount = Object.keys(quizAns).length;
    const hasDiag = !!(state.fit.diagnosis?.stagePrimary);
    const hasSnap = (state.fit.snapshots || []).length >= 1;

    const score = state.fit.metricMatch?.score ?? null;
    const qscore = state.fit.scenarioQuiz?.score ?? null;

    const started = placedCount > 0 || quizCount > 0 || hasDiag;
    const pass = (placedCount >= 6) && (quizCount >= 4) && hasDiag;
    const done = pass && (score !== null ? score >= 60 : true) && (qscore !== null ? qscore >= 60 : true) && hasSnap;

    return { placedCount, quizCount, hasDiag, hasSnap, started, pass, done };
  }

  // Patch autoUpdateProgress to include fit
  const _autoUpdateProgress_PART1 = autoUpdateProgress;
  autoUpdateProgress = function(){
    _autoUpdateProgress_PART1();

    const fit = computeFitCompletion();
    if(fit.done) setTabStatus("fit","done");
    else if(fit.started) setTabStatus("fit","go");
    else setTabStatus("fit","todo");
  };

  // ---------- PART 2: Replace renderMain to handle fit ----------
  const _renderMain_PART1 = renderMain;
  renderMain = function(){
    const main = $("#main");
    main.innerHTML = "";

    if(state.ui.activeTab === "intro"){
      main.appendChild(renderIntroTab());
    }else if(state.ui.activeTab === "market"){
      main.appendChild(renderMarketTab());
    }else if(state.ui.activeTab === "fit"){
      main.appendChild(renderFitTab());
    }else{
      main.appendChild(renderPlaceholderTab(state.ui.activeTab));
    }
  };

  // ---------- PART 2: Fit knowledge bubbles (<=200字 each) ----------
  const FIT_BUBBLES = {
    vp: {
      title: "價值主張契合（Value Proposition Fit）",
      body: "你先證明：特定族群在特定情境，真的被某個痛點困住，且你提供的解法能明顯減痛。看「願意試」「願意回來」「願意推薦」這類訊號，不急著把通路與獲利模型做滿。"
    },
    gtm: {
      title: "上市路徑契合（Go-to-Market Fit）",
      body: "你能把產品穩定推進到客人面前，且有可重複的成交流程。重點是通路、定價、轉換率、CAC 與銷售週期。做得對，新增投入會帶來可預期的新增客戶。"
    },
    bm: {
      title: "商業模式契合（Business Model Fit）",
      body: "你證明這門生意能長久：毛利結構、留存/回購、現金流節奏、CAC 回收期與單客終身價值能站得住腳。這時才適合談擴張速度與組織資源配置。"
    }
  };

  // ---------- PART 2: Metric mapping ----------
  const METRICS = [
    { id:"m1",  text:"試用後回訪率", hint:"願意再回來", defaultStage:"vp" },
    { id:"m2",  text:"核心痛點被解決的比例", hint:"減痛是否成立", defaultStage:"vp" },
    { id:"m3",  text:"NPS / 推薦意願", hint:"口碑訊號", defaultStage:"vp" },
    { id:"m4",  text:"付費轉換率", hint:"賣不賣得動", defaultStage:"gtm" },
    { id:"m5",  text:"獲客成本（CAC）", hint:"通路效率", defaultStage:"gtm" },
    { id:"m6",  text:"銷售週期長短", hint:"成交節奏", defaultStage:"gtm" },
    { id:"m7",  text:"留存率 / 回購率", hint:"會不會留下", defaultStage:"bm" },
    { id:"m8",  text:"毛利率", hint:"賺不賺得到", defaultStage:"bm" },
    { id:"m9",  text:"CAC 回收期", hint:"現金流壓力", defaultStage:"bm" },
    { id:"m10", text:"淨收入留存（NRR）", hint:"擴充是否成立", defaultStage:"bm" },
  ];

  function stageName(stage){
    if(stage==="vp") return "VP Fit";
    if(stage==="gtm") return "GTM Fit";
    if(stage==="bm") return "BM Fit";
    return "未分類";
  }
  function stageNameZh(stage){
    if(stage==="vp") return "價值主張契合";
    if(stage==="gtm") return "上市路徑契合";
    if(stage==="bm") return "商業模式契合";
    return "未分類";
  }

  function ensureFitState(){
    if(!state.fit.metricMatch) state.fit.metricMatch = { placements:{}, score:null };
    if(!state.fit.metricMatch.placements) state.fit.metricMatch.placements = {};
    if(!state.fit.scenarioQuiz) state.fit.scenarioQuiz = { answers:{}, score:null };
    if(!state.fit.scenarioQuiz.answers) state.fit.scenarioQuiz.answers = {};
    if(!state.fit.diagnosis) state.fit.diagnosis = { stagePrimary:"", stageSecondary:"", confidence:0, rationaleText:"" };
    if(!state.fit.snapshots) state.fit.snapshots = [];
  }

  function scoreMetricMatch(){
    ensureFitState();
    const placements = state.fit.metricMatch.placements;
    let total = 0;
    let correct = 0;
    for(const m of METRICS){
      const placed = placements[m.id];
      if(!placed) continue;
      total += 1;
      if(placed === m.defaultStage) correct += 1;
    }
    const score = total === 0 ? null : Math.round((correct/total)*100);
    state.fit.metricMatch.score = score;
    return { total, correct, score };
  }

  // ---------- PART 2: Scenario quiz (6 questions; include multi-select) ----------
  const FIT_QUIZ = [
    {
      id:"fq1",
      type:"single",
      title:"Q1（單選）你做了 MVP 試用，發現很多人說「想要」，但幾乎沒人願意把現有習慣換掉。你最像卡在哪？",
      options:{
        A:"價值主張契合（VP Fit）",
        B:"上市路徑契合（GTM Fit）",
        C:"商業模式契合（BM Fit）",
        D:"以上都不是"
      },
      answer:["A"],
      why:"你還沒證明「減痛強到足以改行為」。"
    },
    {
      id:"fq2",
      type:"multi",
      title:"Q2（複選）你已能穩定成交，但擴大投放後獲客成本大幅上升、銷售週期拉長。這提示什麼？（可複選）",
      options:{
        A:"通路/客群可能不夠聚焦（GTM 問題）",
        B:"你可能把「小量有效」誤當成「可擴張」（GTM 問題）",
        C:"只要把功能加多就會好（不一定）",
        D:"需要重看 CAC、轉換率、成交流程（GTM 問題）"
      },
      answer:["A","B","D"],
      why:"這些都是上市路徑的可重複性與效率問題。"
    },
    {
      id:"fq3",
      type:"single",
      title:"Q3（單選）你留存很高、回購也有，但毛利太低，越賣越累。你最像卡在哪？",
      options:{
        A:"VP Fit",
        B:"GTM Fit",
        C:"BM Fit",
        D:"都不是"
      },
      answer:["C"],
      why:"長久性與單位經濟需要補上。"
    },
    {
      id:"fq4",
      type:"multi",
      title:"Q4（複選）以下哪些指標最常用來判讀「商業模式契合」？（可複選）",
      options:{
        A:"毛利率",
        B:"CAC 回收期",
        C:"留存/回購",
        D:"只看下載量"
      },
      answer:["A","B","C"],
      why:"BM 要能長久：毛利、留存、回收期。"
    },
    {
      id:"fq5",
      type:"single",
      title:"Q5（單選）《陸王》團隊若在早期就投入大量通路鋪貨，但試穿回訪與推薦訊號薄弱，最可能的風險是？",
      options:{
        A:"把 GTM 當成 VP，成本先爆掉",
        B:"把 BM 當成 GTM，速度太慢",
        C:"只要多找 KOL 就沒事",
        D:"以上都不對"
      },
      answer:["A"],
      why:"沒先站穩減痛與回訪，通路只會放大浪費。"
    },
    {
      id:"fq6",
      type:"multi",
      title:"Q6（複選）當你要決定「是不是進入下一個 Fit 階段」，比較可靠的做法是？（可複選）",
      options:{
        A:"用門檻式指標（例如：回訪≥X%、推薦≥Y%）",
        B:"用一兩個成功案例就宣布成功",
        C:"先列出最關鍵的不確定，針對它做實驗",
        D:"同時設定停損線，避免捨不得停"
      },
      answer:["A","C","D"],
      why:"用門檻與停損，把決策變成可推進的流程。"
    },
  ];

  function scoreFitQuiz(){
    ensureFitState();
    const answers = state.fit.scenarioQuiz.answers;
    let total = 0;
    let correct = 0;

    for(const q of FIT_QUIZ){
      total += 1;
      const got = answers[q.id];
      if(!got) continue;
      const gotArr = Array.isArray(got) ? got.slice().sort() : [got].sort();
      const ansArr = q.answer.slice().sort();
      const ok = JSON.stringify(gotArr) === JSON.stringify(ansArr);
      if(ok) correct += 1;
    }
    const score = Math.round((correct/total)*100);
    state.fit.scenarioQuiz.score = score;
    return { total, correct, score };
  }

  // ---------- PART 2: Diagnosis ----------
  function computeFitDiagnosis(){
    ensureFitState();

    const mm = scoreMetricMatch();
    const qz = scoreFitQuiz();

    // stage counts from placements
    const placements = state.fit.metricMatch.placements;
    const counts = { vp:0, gtm:0, bm:0 };
    for(const m of METRICS){
      const st = placements[m.id];
      if(st && counts[st] !== undefined) counts[st] += 1;
    }

    // weighted guess: placements 60%, quiz 40% (coarse)
    // primary based on counts; secondary next
    const sortedStages = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(x=>x[0]);
    const primary = sortedStages[0] || "";
    const secondary = sortedStages[1] || "";

    // confidence: based on how concentrated placements + quiz score
    const totalPlaced = mm.total || 0;
    const lead = totalPlaced ? counts[primary] / totalPlaced : 0;
    const base = Math.round((lead * 60) + (qz.score * 0.40));
    const confidence = clamp(base, 0, 100);

    // rationale (Taiwan wording; concise)
    const reasons = [];
    if(totalPlaced === 0){
      reasons.push("尚未完成指標配對，因此先用情境題結果作初判。");
    }else{
      reasons.push(`你把多數指標放在「${stageNameZh(primary)}」：${counts[primary]}/${totalPlaced}。`);
    }
    reasons.push(`情境題分數：${qz.score}%。`);
    if(primary==="vp") reasons.push("建議先把「願意試→願意回來→願意推薦」做成門檻，再談擴張。");
    if(primary==="gtm") reasons.push("建議聚焦通路與成交流程：轉換率、CAC、銷售週期要能被重複。");
    if(primary==="bm") reasons.push("建議回到單位經濟：毛利、留存/回購、CAC 回收期要站得住腳。");

    state.fit.diagnosis.stagePrimary = primary ? stageName(primary) : "";
    state.fit.diagnosis.stageSecondary = secondary ? stageName(secondary) : "";
    state.fit.diagnosis.confidence = confidence;
    state.fit.diagnosis.rationaleText = reasons.join("\n");

    scheduleSave();
    autoUpdateProgress();
    renderProgress();
  }

  function buildFitSnapshotText(){
    ensureFitState();
    const d = state.fit.diagnosis;
    const mm = state.fit.metricMatch;
    const qz = state.fit.scenarioQuiz;

    const lines = [];
    lines.push("【快照｜Fit 階段】");
    lines.push(`主要判讀：${d.stagePrimary || "未產生"}｜次要：${d.stageSecondary || "未產生"}｜信心：${d.confidence || 0}%`);
    lines.push(`指標配對分數：${mm.score === null ? "—" : (mm.score + "%")}｜情境題分數：${qz.score === null ? "—" : (qz.score + "%")}`);

    // placements summary
    const by = { vp:[], gtm:[], bm:[] };
    for(const m of METRICS){
      const st = mm.placements[m.id];
      if(st && by[st]) by[st].push(m.text);
    }
    lines.push(`VP：${by.vp.length ? by.vp.join("、") : "—"}`);
    lines.push(`GTM：${by.gtm.length ? by.gtm.join("、") : "—"}`);
    lines.push(`BM：${by.bm.length ? by.bm.join("、") : "—"}`);
    lines.push("—");
    lines.push((d.rationaleText || "").trim() ? d.rationaleText : "（尚無診斷說明）");
    return lines.join("\n");
  }

  // ---------- PART 2: Fit Tab renderer ----------
  function renderFitTab(){
    ensureFitState();

    const wrap = document.createElement("div");

    // Hero
    const hero = document.createElement("div");
    hero.className = "panel";
    hero.innerHTML = `
      <div class="hero">
        <div class="hero-badge"></div>
        <div>
          <h2>Fit 階段：你現在是在「值不值得」、還是「賣不賣得動」、或「能不能長久做」？</h2>
          <p>
            用 Venn 先看三種契合的差異，再用「指標配對」與「情境題」把判讀落地。
            這頁完成後，你會產出一段診斷：<b>主要階段＋次要階段＋信心</b>，並能鎖定快照。
          </p>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
            <button class="btn primary" id="fitRunDiagBtn">產生診斷</button>
            <button class="btn" id="fitSnapBtn">鎖定快照</button>
            <button class="btn" id="fitAddNoteBtn">把 Fit 快照加入筆記</button>
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(hero);

    // Venn
    const venn = document.createElement("div");
    venn.className = "panel";
    venn.innerHTML = `
      <div class="section-title">
        <h3>Venn：三種契合</h3>
        <div class="kicker"><span class="pill">點圈圈看 200 字內重點</span></div>
      </div>

      <div class="venn-wrap">
        <div class="venn-top">
          <div class="legend">
            <div class="venn-legend-item"><span class="swatch vp"></span> VP Fit（價值主張）</div>
            <div class="venn-legend-item"><span class="swatch gtm"></span> GTM Fit（上市路徑）</div>
            <div class="venn-legend-item"><span class="swatch bm"></span> BM Fit（商業模式）</div>
          </div>
          <div class="small-muted">提示：越往右邊越靠近「可擴張」；越往上越靠近「長久性」。</div>
        </div>

        <svg class="venn-svg" id="vennSvg" viewBox="0 0 720 320" role="img" aria-label="Fit Venn">
          <!-- background grid (subtle) -->
          <defs>
            <pattern id="grid" width="24" height="24" patternUnits="userSpaceOnUse">
              <path d="M 24 0 L 0 0 0 24" fill="none" stroke="rgba(17,24,39,.06)" stroke-width="1" />
            </pattern>
          </defs>
          <rect x="0" y="0" width="720" height="320" fill="url(#grid)" />

          <!-- circles -->
          <circle id="c_vp"  cx="280" cy="165" r="120" fill="rgba(245,158,11,.22)" stroke="rgba(245,158,11,.55)" stroke-width="3" />
          <circle id="c_gtm" cx="420" cy="165" r="120" fill="rgba(37,99,235,.20)" stroke="rgba(37,99,235,.55)" stroke-width="3" />
          <circle id="c_bm"  cx="350" cy="105" r="120" fill="rgba(16,185,129,.18)" stroke="rgba(16,185,129,.55)" stroke-width="3" />

          <!-- labels -->
          <text x="220" y="170" font-size="16" font-weight="900" fill="rgba(17,24,39,.86)">VP Fit</text>
          <text x="470" y="170" font-size="16" font-weight="900" fill="rgba(17,24,39,.86)">GTM Fit</text>
          <text x="336" y="80"  font-size="16" font-weight="900" fill="rgba(17,24,39,.86)">BM Fit</text>

          <text x="190" y="195" font-size="12" fill="rgba(17,24,39,.72)">值不值得（減痛/回訪）</text>
          <text x="446" y="195" font-size="12" fill="rgba(17,24,39,.72)">賣不賣得動（轉換/CAC）</text>
          <text x="312" y="110" font-size="12" fill="rgba(17,24,39,.72)">能不能長久（毛利/留存）</text>

          <!-- center note -->
          <rect x="276" y="140" width="168" height="44" rx="14" fill="rgba(255,255,255,.78)" stroke="rgba(229,231,235,.95)" />
          <text x="360" y="168" text-anchor="middle" font-size="12" fill="rgba(17,24,39,.72)">三者交集：可擴張、可長久</text>
        </svg>

        <div class="venn-note">點選任何一個圈圈，會顯示該階段的「最短可用理解」。</div>

        <div class="bubble-card" id="bubble_vp">
          <div class="bubble-head">
            <div class="bubble-title">${FIT_BUBBLES.vp.title}</div>
            <button class="btn small" data-bubble-close="vp">收起</button>
          </div>
          <div class="bubble-body">${FIT_BUBBLES.vp.body}</div>
        </div>

        <div class="bubble-card" id="bubble_gtm">
          <div class="bubble-head">
            <div class="bubble-title">${FIT_BUBBLES.gtm.title}</div>
            <button class="btn small" data-bubble-close="gtm">收起</button>
          </div>
          <div class="bubble-body">${FIT_BUBBLES.gtm.body}</div>
        </div>

        <div class="bubble-card" id="bubble_bm">
          <div class="bubble-head">
            <div class="bubble-title">${FIT_BUBBLES.bm.title}</div>
            <button class="btn small" data-bubble-close="bm">收起</button>
          </div>
          <div class="bubble-body">${FIT_BUBBLES.bm.body}</div>
        </div>
      </div>
    `;
    wrap.appendChild(venn);

    // Metric drag-drop + Quiz + Diagnosis
    const work = document.createElement("div");
    work.className = "panel";
    work.innerHTML = `
      <div class="section-title">
        <h3>兩種證據：指標配對 × 情境題</h3>
        <div class="kicker"><span class="pill">用來判讀你在哪個階段</span></div>
      </div>

      <div class="drag-area">
        <div class="bank">
          <h4>指標卡（拖曳到右邊分類）</h4>
          <div class="small-muted">把你最想先看/最能代表現況的指標拖過去。點右邊已放入的標籤可移回。</div>
          <div class="draggables" id="metricDeck"></div>
        </div>

        <div class="bank">
          <h4>分類區（VP / GTM / BM）</h4>
          <div class="small-muted">不要求一次就對。你是在用分類逼自己說清楚「目前最卡的是什麼」。</div>
          <div class="dropzones" id="dropzones"></div>

          <div class="scorebar">
            <div class="scorebox">
              <div class="k">指標配對分數（教學用）</div>
              <div class="v" id="mmScore">—</div>
              <div class="s">分數不是成績；是提醒你：分類是否一致。</div>
            </div>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn small" id="mmReset">清空分類</button>
              <button class="btn small" id="mmAutoFill">用預設示範填入</button>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="font-weight:900">情境題（6 題，含複選）</div>
        <div class="small-muted" style="margin-top:8px; line-height:1.6">
          用情境題校正直覺：如果你的答案與你指標分類差很多，代表你可能在「名詞懂了，但判讀還沒穩」。
        </div>
        <div class="quiz" id="fitQuiz" style="margin-top:10px"></div>

        <div class="scorebar">
          <div class="scorebox">
            <div class="k">情境題分數（教學用）</div>
            <div class="v" id="quizScore">—</div>
            <div class="s">建議先達到 60% 以上再往下一頁。</div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn small" id="quizReveal">顯示解析</button>
            <button class="btn small danger" id="quizReset">清空作答</button>
          </div>
        </div>
      </div>

      <div class="diag" id="diagBox">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
          <div style="font-weight:950">你的 Fit 階段診斷</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn small" id="fitCheckBtn">檢查完成度</button>
            <button class="btn small" id="fitNextBtn">下一步：MVP 驗證</button>
          </div>
        </div>

        <div class="row">
          <div class="col">
            <div class="k">主要階段</div>
            <div class="big" id="diagPrimary">—</div>
          </div>
          <div class="col">
            <div class="k">次要階段</div>
            <div class="big" id="diagSecondary">—</div>
          </div>
          <div class="col">
            <div class="k">信心（0–100）</div>
            <div class="big" id="diagConfidence">—</div>
          </div>
        </div>

        <div class="field">
          <label>診斷說明（可改寫，會跟著暫存）</label>
          <textarea id="diagText" placeholder="按「產生診斷」後會出現內容。你也可以自行改寫成小組共識版本。"></textarea>
          <div class="hint">建議寫法：目前卡點（1 句）→ 你打算先驗證的門檻（1 句）→ 下一步行動（1 句）。</div>
        </div>

        <div class="fit-actions">
          <button class="btn primary" id="fitRunDiagBtn2">重新產生診斷</button>
          <button class="btn" id="fitSnapBtn2">鎖定快照</button>
          <button class="btn" id="fitAddNoteBtn2">加入筆記</button>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:900">快照列表</div>
          <div class="small-muted" style="margin-top:8px; line-height:1.6">
            你可以生成多份快照，用來對照不同小組討論版本。快照也能一鍵加入筆記。
          </div>
          <div id="fitSnapshotList" style="display:grid; gap:10px; margin-top:10px"></div>
        </div>
      </div>
    `;
    wrap.appendChild(work);

    // mount events
    setTimeout(()=>{
      // Venn interactions
      const showBubble = (k)=>{
        const ids = ["vp","gtm","bm"];
        ids.forEach(x=>{
          const el = $("#bubble_"+x);
          if(!el) return;
          const open = (x===k);
          el.classList.toggle("show", open);
          state.fit.vennOpened[x] = open;
        });
        scheduleSave();
      };

      // restore bubble open state
      if(state.fit.vennOpened?.vp) $("#bubble_vp")?.classList.add("show");
      if(state.fit.vennOpened?.gtm) $("#bubble_gtm")?.classList.add("show");
      if(state.fit.vennOpened?.bm) $("#bubble_bm")?.classList.add("show");

      $("#c_vp")?.addEventListener("click", ()=> showBubble("vp"));
      $("#c_gtm")?.addEventListener("click", ()=> showBubble("gtm"));
      $("#c_bm")?.addEventListener("click", ()=> showBubble("bm"));

      $$("button[data-bubble-close]").forEach(b=>{
        b.onclick = ()=>{
          const k = b.getAttribute("data-bubble-close");
          $("#bubble_"+k)?.classList.remove("show");
          state.fit.vennOpened[k] = false;
          scheduleSave();
        };
      });

      // Drag/drop deck
      renderMetricDeck();
      renderDropzones();

      $("#mmReset").onclick = ()=>{
        if(!confirm("確定清空分類？")) return;
        state.fit.metricMatch.placements = {};
        state.fit.metricMatch.score = null;
        scheduleSave();
        renderMetricDeck();
        renderDropzones();
        updateFitScores();
        autoUpdateProgress();
      };

      $("#mmAutoFill").onclick = ()=>{
        // fill with defaults for demonstration
        const p = {};
        METRICS.forEach(m=> p[m.id] = m.defaultStage);
        state.fit.metricMatch.placements = p;
        scheduleSave();
        renderMetricDeck();
        renderDropzones();
        updateFitScores();
        autoUpdateProgress();
        toast("已用示範分類填入（可自行再調整）。","ok");
      };

      // Quiz
      renderFitQuiz(false);
      updateFitScores();
      renderDiagnosisBox();

      $("#quizReveal").onclick = ()=>{
        renderFitQuiz(true);
        toast("已顯示解析（可以再改答案）。","ok");
      };

      $("#quizReset").onclick = ()=>{
        if(!confirm("確定清空情境題作答？")) return;
        state.fit.scenarioQuiz.answers = {};
        state.fit.scenarioQuiz.score = null;
        scheduleSave();
        renderFitQuiz(false);
        updateFitScores();
        autoUpdateProgress();
      };

      // Diagnosis textarea bind
      $("#diagText").addEventListener("input", ()=>{
        state.fit.diagnosis.rationaleText = $("#diagText").value;
        scheduleSave();
      });

      // Buttons (top + inside diag)
      const runDiag = ()=>{
        computeFitDiagnosis();
        renderDiagnosisBox();
        updateFitScores();
        toast("已產生診斷（可自行改寫）。","ok");
      };

      const snap = ()=>{
        if(!state.fit.diagnosis.stagePrimary){
          toast("先按「產生診斷」再鎖定快照。","warn");
          return;
        }
        const snapshot = {
          id: uid(),
          createdAt: nowISO(),
          metricMatch: structuredClone(state.fit.metricMatch),
          scenarioQuiz: structuredClone(state.fit.scenarioQuiz),
          diagnosis: structuredClone(state.fit.diagnosis),
        };
        state.fit.snapshots.unshift(snapshot);
        scheduleSave();
        renderFitSnapshots();
        autoUpdateProgress();
        toast("已鎖定 Fit 快照。","ok");
      };

      const addFitNote = ()=>{
        addNote({
          title: "快照｜Fit 階段",
          content: buildFitSnapshotText(),
          tags: ["Fit","課堂"]
        });
      };

      $("#fitRunDiagBtn").onclick = runDiag;
      $("#fitRunDiagBtn2").onclick = runDiag;
      $("#fitSnapBtn").onclick = snap;
      $("#fitSnapBtn2").onclick = snap;
      $("#fitAddNoteBtn").onclick = addFitNote;
      $("#fitAddNoteBtn2").onclick = addFitNote;

      $("#fitCheckBtn").onclick = ()=>{
        const c = computeFitCompletion();
        if(c.done) toast("Fit 完成：已診斷、已有快照，且互動資料足夠。","ok");
        else{
          const miss = [];
          if(c.placedCount < 6) miss.push("指標配對至少放 6 張卡");
          if(c.quizCount < 4) miss.push("情境題至少回答 4 題");
          if(!c.hasDiag) miss.push("產生診斷");
          if(!c.hasSnap) miss.push("至少 1 份快照");
          toast("尚未完成：" + miss.join("、"), "warn");
        }
        autoUpdateProgress();
        renderProgress();
      };

      $("#fitNextBtn").onclick = ()=> navigate("mvp");

      renderFitSnapshots();

      // if diagnosis already exists, populate textarea
      $("#diagText").value = state.fit.diagnosis.rationaleText || "";

    },0);

    return wrap;
  }

  // ---------- Metric deck + zones ----------
  function renderMetricDeck(){
    ensureFitState();
    const el = $("#metricDeck");
    if(!el) return;
    el.innerHTML = "";

    const placed = state.fit.metricMatch.placements;

    // show only unplaced in deck
    const unplaced = METRICS.filter(m=> !placed[m.id]);

    if(!unplaced.length){
      const done = document.createElement("div");
      done.className = "small-muted";
      done.textContent = "所有指標卡都已分類。你可以點右邊的標籤把卡移回。";
      el.appendChild(done);
      return;
    }

    unplaced.forEach(m=>{
      const card = document.createElement("div");
      card.className = "metric-card";
      card.draggable = true;
      card.dataset.mid = m.id;
      card.innerHTML = `
        <div style="font-weight:900">${m.text}</div>
        <div class="tag"><span class="mini"></span>${m.hint}</div>
      `;
      card.ondragstart = (e)=>{
        e.dataTransfer.setData("text/metricId", m.id);
        e.dataTransfer.effectAllowed = "move";
      };
      el.appendChild(card);
    });
  }

  function renderDropzones(){
    ensureFitState();
    const el = $("#dropzones");
    if(!el) return;
    el.innerHTML = "";

    const stages = [
      { id:"vp",  title:"VP Fit（值不值得）", sw:"vp" },
      { id:"gtm", title:"GTM Fit（賣不賣得動）", sw:"gtm" },
      { id:"bm",  title:"BM Fit（能不能長久）", sw:"bm" },
    ];

    const placements = state.fit.metricMatch.placements;
    const byStage = { vp:[], gtm:[], bm:[] };
    for(const m of METRICS){
      const st = placements[m.id];
      if(st && byStage[st]) byStage[st].push(m);
    }

    stages.forEach(s=>{
      const z = document.createElement("div");
      z.className = "zone";
      z.dataset.stage = s.id;

      const items = byStage[s.id] || [];
      z.innerHTML = `
        <div class="zhead">
          <div class="ztitle"><span class="swatch ${s.sw}" style="width:10px;height:10px"></span>${s.title}</div>
          <div class="zcount">已放入：${items.length}</div>
        </div>
        <div class="zitems" id="zitems_${s.id}"></div>
      `;

      // drag events
      z.ondragover = (e)=>{ e.preventDefault(); z.classList.add("over"); };
      z.ondragleave = ()=>{ z.classList.remove("over"); };
      z.ondrop = (e)=>{
        e.preventDefault();
        z.classList.remove("over");
        const metricId = e.dataTransfer.getData("text/metricId");
        if(!metricId) return;
        state.fit.metricMatch.placements[metricId] = s.id;
        scheduleSave();
        renderMetricDeck();
        renderDropzones();
        updateFitScores();
        autoUpdateProgress();
      };

      el.appendChild(z);

      const itemsEl = $("#zitems_"+s.id);
      items.forEach(m=>{
        const chip = document.createElement("div");
        chip.className = "zitem";
        chip.textContent = m.text;
        chip.title = "點一下移回指標卡";
        chip.onclick = ()=>{
          delete state.fit.metricMatch.placements[m.id];
          scheduleSave();
          renderMetricDeck();
          renderDropzones();
          updateFitScores();
          autoUpdateProgress();
        };
        itemsEl.appendChild(chip);
      });
    });
  }

  function updateFitScores(){
    // metric match score
    const mm = scoreMetricMatch();
    const mmEl = $("#mmScore");
    if(mmEl) mmEl.textContent = (mm.score===null ? "—" : (mm.score + "%"));

    // quiz score
    const qz = scoreFitQuiz();
    const qEl = $("#quizScore");
    if(qEl) qEl.textContent = (isFinite(qz.score) ? (qz.score + "%") : "—");
  }

  // ---------- Quiz renderer ----------
  function renderFitQuiz(showWhy=false){
    ensureFitState();
    const el = $("#fitQuiz");
    if(!el) return;
    el.innerHTML = "";

    FIT_QUIZ.forEach(q=>{
      const box = document.createElement("div");
      box.className = "q";
      box.innerHTML = `
        <div class="q-title">${q.title}</div>
        <div class="opts" id="opts_${q.id}"></div>
        <div class="feedback" style="${showWhy ? "" : "display:none"}">解析：${q.why}</div>
      `;
      const optsEl = $("#opts_"+q.id, box);

      const saved = state.fit.scenarioQuiz.answers[q.id];

      Object.entries(q.options).forEach(([k,v])=>{
        const opt = document.createElement("label");
        opt.className = "opt";
        const isMulti = q.type==="multi";
        opt.innerHTML = `
          <input type="${isMulti ? "checkbox" : "radio"}" name="${q.id}" value="${k}" />
          <div><b>${k}.</b> ${v}</div>
        `;

        const input = $("input", opt);

        // restore
        if(saved){
          if(isMulti && Array.isArray(saved) && saved.includes(k)) input.checked = true;
          if(!isMulti && saved === k) input.checked = true;
        }

        input.addEventListener("change", ()=>{
          if(isMulti){
            const cur = new Set(Array.isArray(state.fit.scenarioQuiz.answers[q.id]) ? state.fit.scenarioQuiz.answers[q.id] : []);
            if(input.checked) cur.add(k); else cur.delete(k);
            state.fit.scenarioQuiz.answers[q.id] = Array.from(cur);
          }else{
            state.fit.scenarioQuiz.answers[q.id] = k;
          }
          scheduleSave();
          updateFitScores();
          autoUpdateProgress();
          renderProgress();

          if(showWhy){
            // keep feedback visible
            $(".feedback", box).style.display = "";
          }
        });

        // Marking if showWhy: highlight correct vs wrong based on current selection
        if(showWhy){
          const ans = q.answer;
          const got = state.fit.scenarioQuiz.answers[q.id];
          const gotArr = q.type==="multi" ? (Array.isArray(got)?got:[]) : (got ? [got] : []);
          const isChosen = gotArr.includes(k);
          const isCorrect = ans.includes(k);

          // If chosen and correct => correct outline; chosen and wrong => wrong outline
          // Also show correct ones in subtle correct outline even if not chosen
          if(isChosen && isCorrect) opt.classList.add("correct");
          if(isChosen && !isCorrect) opt.classList.add("wrong");
          if(!isChosen && isCorrect) opt.style.outline = "3px solid rgba(16,185,129,.10)";
        }

        optsEl.appendChild(opt);
      });

      el.appendChild(box);
    });
  }

  // ---------- Diagnosis render + snapshots ----------
  function renderDiagnosisBox(){
    ensureFitState();
    const d = state.fit.diagnosis;
    const p = $("#diagPrimary");
    const s = $("#diagSecondary");
    const c = $("#diagConfidence");
    const t = $("#diagText");

    if(p) p.textContent = d.stagePrimary || "—";
    if(s) s.textContent = d.stageSecondary || "—";
    if(c) c.textContent = (isFinite(d.confidence) ? (d.confidence + "%") : "—");
    if(t && (t.value||"").trim().length===0 && (d.rationaleText||"").trim().length){
      t.value = d.rationaleText;
    }
  }

  function renderFitSnapshots(){
    ensureFitState();
    const el = $("#fitSnapshotList");
    if(!el) return;
    el.innerHTML = "";

    const snaps = state.fit.snapshots || [];
    if(!snaps.length){
      el.innerHTML = `<div class="small-muted">尚無快照。按「鎖定快照」即可生成。</div>`;
      return;
    }

    snaps.forEach((s,i)=>{
      const card = document.createElement("div");
      card.className = "card";
      const dt = new Date(s.createdAt).toLocaleString("zh-Hant");
      const primary = s.diagnosis?.stagePrimary || "—";
      const conf = isFinite(s.diagnosis?.confidence) ? (s.diagnosis.confidence + "%") : "—";
      card.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
          <div style="font-weight:900">快照 #${snaps.length - i}</div>
          <div class="pill">${dt}</div>
        </div>
        <div class="small-muted" style="margin-top:8px; line-height:1.6">
          主要：<b>${primary}</b>｜信心：<b>${conf}</b>
        </div>
        <div class="small-muted" style="margin-top:8px; white-space:pre-wrap; line-height:1.6">${buildFitSnapshotTextFromSnap(s)}</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
          <button class="btn small" data-act="apply" data-id="${s.id}">套用到目前</button>
          <button class="btn small" data-act="note" data-id="${s.id}">加入筆記</button>
          <button class="btn small danger" data-act="del" data-id="${s.id}">刪除</button>
        </div>
      `;
      el.appendChild(card);
    });

    $$("button[data-act]", el).forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-id");
        const act = b.getAttribute("data-act");
        const snap = (state.fit.snapshots||[]).find(x=>x.id===id);
        if(!snap) return;

        if(act==="apply"){
          state.fit.metricMatch = structuredClone(snap.metricMatch);
          state.fit.scenarioQuiz = structuredClone(snap.scenarioQuiz);
          state.fit.diagnosis = structuredClone(snap.diagnosis);
          scheduleSave();
          toast("已套用 Fit 快照。","ok");
          renderMain();
        }
        if(act==="note"){
          addNote({
            title: "快照｜Fit 階段",
            content: buildFitSnapshotTextFromSnap(snap)
          });
        }
        if(act==="del"){
          if(!confirm("確定刪除這份快照？")) return;
          state.fit.snapshots = state.fit.snapshots.filter(x=>x.id!==id);
          scheduleSave();
          renderFitSnapshots();
          autoUpdateProgress();
          toast("已刪除快照。","ok");
        }
      };
    });
  }

  function buildFitSnapshotTextFromSnap(snap){
    const d = snap.diagnosis || {};
    const mm = snap.metricMatch || {};
    const qz = snap.scenarioQuiz || {};
    const lines = [];
    lines.push("【快照｜Fit 階段】");
    lines.push(`主要判讀：${d.stagePrimary || "未產生"}｜次要：${d.stageSecondary || "未產生"}｜信心：${d.confidence ?? 0}%`);
    lines.push(`指標配對分數：${mm.score === null ? "—" : (mm.score + "%")}｜情境題分數：${qz.score === null ? "—" : (qz.score + "%")}`);

    const by = { vp:[], gtm:[], bm:[] };
    const placements = mm.placements || {};
    for(const m of METRICS){
      const st = placements[m.id];
      if(st && by[st]) by[st].push(m.text);
    }
    lines.push(`VP：${by.vp.length ? by.vp.join("、") : "—"}`);
    lines.push(`GTM：${by.gtm.length ? by.gtm.join("、") : "—"}`);
    lines.push(`BM：${by.bm.length ? by.bm.join("、") : "—"}`);
    lines.push("—");
    lines.push((d.rationaleText || "").trim() ? d.rationaleText : "（尚無診斷說明）");
    return lines.join("\n");
  }

  // ---------- PART 2: ensure plots resize doesn’t break fit (no-op) ----------
  // (kept intentionally)

  // ---------- PART 2: call progress refresh once after patch ----------
  autoUpdateProgress();
  renderProgress();
</script>
<!-- =========================
PART 3（Tab4: MVP 驗證 / Tab5: Pivot）
貼入方式（延續你目前「同一份 HTML」）：

A) 把「PART 3 CSS」貼到 <style>...</style> 的結尾（</style> 前）
B) 把「PART 3 JS」貼到 <script>...</script> 的結尾（</script> 前）
   - 這段會再「擴充 renderMain」與「擴充 autoUpdateProgress」，不會破壞 Part 1/2 的功能
========================= -->

<!-- =========================
A) PART 3 CSS（貼到 </style> 前）
========================= -->
<style>
  /* ===== PART 3: MVP + Pivot styles ===== */

  .grid-2{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  @media (max-width: 980px){
    .grid-2{ grid-template-columns: 1fr; }
  }

  .grid-3{
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
  }
  @media (max-width: 980px){
    .grid-3{ grid-template-columns: 1fr; }
  }

  .mvp-hero-rail{
    display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;
  }

  .hypo-deck{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: var(--shadow-inset);
    padding: 12px 12px;
    min-height: 220px;
  }
  .hypo-deck h4{ margin:0; font-size: var(--fz-h2); }
  .hypo-cards{
    margin-top: 10px;
    display:flex;
    flex-wrap:wrap;
    gap: 10px;
  }
  .hypo-card{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.06), -6px -6px 14px rgba(255,255,255,.85);
    padding: 10px 10px;
    cursor: grab;
    user-select:none;
    max-width: 100%;
    min-width: 240px;
  }
  .hypo-card:active{ cursor:grabbing; }
  .hypo-title{ font-weight: 950; }
  .hypo-meta{ margin-top:6px; font-size: var(--fz-xs); color: var(--muted2); line-height:1.4; }

  .rank-zone{
    border-radius: 18px;
    border: 1px dashed rgba(107,114,128,.35);
    background: rgba(255,255,255,.90);
    box-shadow: 6px 6px 14px rgba(17,24,39,.05), -6px -6px 14px rgba(255,255,255,.80);
    padding: 12px 12px;
    min-height: 220px;
  }
  .rank-zone.over{
    outline: 3px solid rgba(37,99,235,.14);
    border-color: rgba(37,99,235,.35);
  }
  .rank-zone h4{ margin:0; font-size: var(--fz-h2); }
  .rank-list{
    margin-top: 10px;
    display:grid;
    gap: 10px;
  }
  .rank-item{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.06), -6px -6px 14px rgba(255,255,255,.85);
    padding: 10px 10px;
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap: 10px;
  }
  .rank-badge{
    width: 28px; height: 28px;
    border-radius: 999px;
    display:flex; align-items:center; justify-content:center;
    background: rgba(17,24,39,.86);
    color:white;
    font-weight: 950;
    flex:0 0 auto;
    box-shadow: 0 6px 18px rgba(17,24,39,.18);
  }
  .rank-body{
    flex:1 1 auto;
    min-width: 0;
  }
  .rank-actions{
    display:flex; gap:8px; flex-wrap:wrap;
  }

  .signal-board{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: var(--shadow-inset);
    padding: 12px 12px;
  }
  .signal-board h4{ margin:0; font-size: var(--fz-h2); }
  .signal-cols{
    margin-top: 10px;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 980px){
    .signal-cols{ grid-template-columns: 1fr; }
  }
  .sig-col{
    border-radius: 18px;
    border: 1px dashed rgba(107,114,128,.35);
    background: rgba(255,255,255,.90);
    box-shadow: 6px 6px 14px rgba(17,24,39,.05), -6px -6px 14px rgba(255,255,255,.80);
    padding: 10px 10px;
    min-height: 160px;
  }
  .sig-col.over{
    outline: 3px solid rgba(245,158,11,.14);
    border-color: rgba(245,158,11,.35);
  }
  .sig-head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    margin-bottom: 8px;
  }
  .sig-head b{ font-weight: 950; }
  .sig-chip{
    border-radius: 999px;
    padding: 6px 10px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.05), -6px -6px 14px rgba(255,255,255,.85);
    font-size: var(--fz-xs);
    cursor:pointer;
    user-select:none;
  }
  .sig-deck{
    margin-top: 8px;
    display:flex;
    flex-wrap:wrap;
    gap: 10px;
  }
  .sig-card{
    border-radius: 16px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.06), -6px -6px 14px rgba(255,255,255,.85);
    padding: 10px 10px;
    cursor: grab;
    user-select:none;
    min-width: 220px;
  }
  .sig-card:active{ cursor:grabbing; }
  .sig-title{ font-weight: 950; }
  .sig-meta{ margin-top:6px; font-size: var(--fz-xs); color: var(--muted2); line-height:1.4; }

  .exp-sheet{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: var(--shadow-inset);
    padding: 12px 12px;
  }
  .exp-sheet h4{ margin:0; font-size: var(--fz-h2); }
  .exp-list{
    margin-top: 10px;
    display:grid;
    gap: 12px;
  }
  .exp-card{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.06), -6px -6px 14px rgba(255,255,255,.85);
    padding: 12px 12px;
  }
  .exp-card .top{
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    flex-wrap:wrap;
  }
  .exp-card .top b{ font-weight:950; }
  .exp-row{
    margin-top: 10px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 980px){
    .exp-row{ grid-template-columns: 1fr; }
  }
  .mini-field label{
    display:block;
    font-size: var(--fz-xs);
    color: var(--muted);
    margin-bottom: 6px;
  }
  .mini-field input, .mini-field select, .mini-field textarea{
    width: 100%;
    border-radius: 14px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.94);
    box-shadow: var(--shadow-inset);
    padding: 10px 10px;
    font-size: var(--fz-sm);
  }
  .mini-field textarea{ min-height: 88px; resize: vertical; }
  .slider{
    display:flex; align-items:center; gap:10px;
  }
  .slider input[type="range"]{ width: 100%; }
  .slider .pill{
    min-width: 80px;
    text-align:center;
  }

  .pivot-board{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: var(--shadow-inset);
    padding: 12px 12px;
  }
  .pivot-board h4{ margin:0; font-size: var(--fz-h2); }
  .traffic{
    margin-top: 10px;
    display:grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
  }
  @media (max-width: 980px){
    .traffic{ grid-template-columns: 1fr; }
  }
  .tbox{
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.06), -6px -6px 14px rgba(255,255,255,.85);
    padding: 12px 12px;
    min-height: 160px;
  }
  .tbox .head{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .tbox .head b{ font-weight: 950; }
  .tbox .desc{ margin-top:8px; font-size: var(--fz-xs); color: var(--muted2); line-height:1.5; }

  .linkmap{
    margin-top: 12px;
    border-radius: 18px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.06), -6px -6px 14px rgba(255,255,255,.85);
    padding: 12px 12px;
  }
  .linkmap .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-top: 10px;
  }
  .arrow{
    border-radius: 999px;
    padding: 6px 10px;
    border: 1px solid rgba(229,231,235,.95);
    background: rgba(255,255,255,.92);
    box-shadow: 6px 6px 14px rgba(17,24,39,.05), -6px -6px 14px rgba(255,255,255,.85);
    font-size: var(--fz-xs);
    color: var(--muted2);
  }
  .loglist{
    margin-top: 10px;
    display:grid;
    gap: 10px;
  }
</style>

<!-- =========================
B) PART 3 JS（貼到 </script> 前）
========================= -->
<script>
  /* =========================
     PART 3: MVP + Pivot
     - Tab4: MVP 驗證（假設 Top3 排序、訊號卡分類、實驗單生成、快照、加入筆記）
     - Tab5: Pivot（紅黃綠判讀、Pivot 類型、舊→新假設連結、決策紀錄、快照）
     - 擴充 renderMain() 與 autoUpdateProgress()
     ========================= */

  // ---------- Safety: Ensure states ----------
  function ensureMvpState(){
    if(!state.mvp) state.mvp = {};
    if(!state.mvp.hypotheses) state.mvp.hypotheses = seedMvpHypotheses();
    if(!state.mvp.rankTop3) state.mvp.rankTop3 = []; // store hypo ids
    if(!state.mvp.signal) state.mvp.signal = { placements:{}, score:null }; // signalId -> bucket
    if(!state.mvp.experiments) state.mvp.experiments = {}; // hypoId -> exp fields
    if(!state.mvp.snapshots) state.mvp.snapshots = [];
  }

  function ensurePivotState(){
    if(!state.pivot) state.pivot = {};
    if(!state.pivot.traffic) state.pivot.traffic = { green:false, yellow:false, red:false, rationale:"" };
    if(!state.pivot.pivotType) state.pivot.pivotType = "";
    if(!state.pivot.oldHypoRef) state.pivot.oldHypoRef = ""; // string
    if(!state.pivot.newHypo) state.pivot.newHypo = "";
    if(!state.pivot.linkReason) state.pivot.linkReason = "";
    if(!state.pivot.decisionLog) state.pivot.decisionLog = [];
    if(!state.pivot.snapshots) state.pivot.snapshots = [];
  }

  // ---------- Progress completion ----------
  function computeMvpCompletion(){
    ensureMvpState();
    // Need: Top3 selected (3), at least 6 signal placements, at least 2 experiment cards filled, at least 1 snapshot
    const top3 = state.mvp.rankTop3 || [];
    const sigCount = Object.keys(state.mvp.signal?.placements || {}).length;
    const expFilled = countFilledExperiments();
    const hasSnap = (state.mvp.snapshots || []).length >= 1;

    const started = top3.length > 0 || sigCount > 0 || expFilled > 0;
    const pass = (top3.length >= 3) && (sigCount >= 6) && (expFilled >= 2);
    const done = pass && hasSnap;
    return { top3Count:top3.length, sigCount, expFilled, hasSnap, started, pass, done };
  }

  function computePivotCompletion(){
    ensurePivotState();
    // Need: traffic chosen (one of them), pivot type, new hypothesis text, at least 1 log entry, at least 1 snapshot
    const t = state.pivot.traffic || {};
    const trafficChosen = !!(t.green || t.yellow || t.red);
    const hasType = !!state.pivot.pivotType;
    const hasNew = (state.pivot.newHypo || "").trim().length >= 10;
    const hasLog = (state.pivot.decisionLog || []).length >= 1;
    const hasSnap = (state.pivot.snapshots || []).length >= 1;

    const started = trafficChosen || hasType || hasNew || hasLog;
    const pass = trafficChosen && hasType && hasNew && hasLog;
    const done = pass && hasSnap;
    return { trafficChosen, hasType, hasNew, hasLog, hasSnap, started, pass, done };
  }

  function countFilledExperiments(){
    ensureMvpState();
    const top3 = state.mvp.rankTop3 || [];
    let filled = 0;
    for(const id of top3){
      const e = state.mvp.experiments[id];
      if(!e) continue;
      const ok =
        (e.metric||"").trim().length >= 2 &&
        (e.threshold||"").trim().length >= 1 &&
        (e.method||"").trim().length >= 5 &&
        (e.duration||"").trim().length >= 2;
      if(ok) filled += 1;
    }
    return filled;
  }

  // ---------- Extend autoUpdateProgress ----------
  const _autoUpdateProgress_PART2 = autoUpdateProgress;
  autoUpdateProgress = function(){
    _autoUpdateProgress_PART2();

    // MVP
    const m = computeMvpCompletion();
    if(m.done) setTabStatus("mvp","done");
    else if(m.started) setTabStatus("mvp","go");
    else setTabStatus("mvp","todo");

    // Pivot
    const p = computePivotCompletion();
    if(p.done) setTabStatus("pivot","done");
    else if(p.started) setTabStatus("pivot","go");
    else setTabStatus("pivot","todo");
  };

  // ---------- Extend renderMain to include mvp + pivot ----------
  const _renderMain_PART2 = renderMain;
  renderMain = function(){
    const main = $("#main");
    main.innerHTML = "";

    if(state.ui.activeTab === "intro"){
      main.appendChild(renderIntroTab());
    }else if(state.ui.activeTab === "market"){
      main.appendChild(renderMarketTab());
    }else if(state.ui.activeTab === "fit"){
      main.appendChild(renderFitTab());
    }else if(state.ui.activeTab === "mvp"){
      main.appendChild(renderMvpTab());
    }else if(state.ui.activeTab === "pivot"){
      main.appendChild(renderPivotTab());
    }else{
      main.appendChild(renderPlaceholderTab(state.ui.activeTab));
    }
  };

  // ---------- Seed MVP hypotheses (includes Rikuou context) ----------
  function seedMvpHypotheses(){
    // Use Fit diagnosis if exists
    const fitPrimary = (state.fit?.diagnosis?.stagePrimary || "").toLowerCase();
    const stageGuess = fitPrimary.includes("vp") ? "vp" : (fitPrimary.includes("gtm") ? "gtm" : (fitPrimary.includes("bm") ? "bm" : "vp"));

    // Rikuou context: "足袋跑鞋" -> hypotheses around pain, trial, distribution, unit economics
    return [
      {
        id:"h1",
        title:"痛點假設：跑者在長距離時更在意『貼地感＋保護』的平衡",
        stage: stageGuess,
        context:"《陸王》：足袋工廠想用「足袋」做跑鞋，主張貼地、輕量、抓地。",
        risk:"如果跑者不把這當成核心痛點，VP Fit 站不住。"
      },
      {
        id:"h2",
        title:"族群假設：最先買單的是『有傷痛史/腳感敏感』的跑者，而不是大眾跑者",
        stage:"vp",
        context:"《陸王》：早期需要找到願意試、願意忍受不完美的人。",
        risk:"客群不精準會導致試用訊號混雜。"
      },
      {
        id:"h3",
        title:"使用情境假設：短期試跑無法說服人，必須設計『可感知差異』的體驗",
        stage:"vp",
        context:"《陸王》：穿起來要立刻感覺不同，否則回到原本鞋款。",
        risk:"驗證方法錯，會誤判市場不要。"
      },
      {
        id:"h4",
        title:"通路假設：先用社群/跑團/小型活動成交，比一開始鋪大型通路更有效",
        stage:"gtm",
        context:"《陸王》：資源有限時，先找能產生口碑與回訪的場景。",
        risk:"太早擴張通路，CAC 先爆掉。"
      },
      {
        id:"h5",
        title:"定價假設：跑者可接受『比一般跑鞋略高』，但要有明確性能敘事",
        stage:"gtm",
        context:"《陸王》：不是便宜就賣，故事與性能要對上。",
        risk:"定價與價值敘事不一致會卡在轉換率。"
      },
      {
        id:"h6",
        title:"單位經濟假設：若製程良率提升到 X%，毛利才能支撐持續迭代",
        stage:"bm",
        context:"《陸王》：工藝與量產之間的拉扯，會直接反映在成本與毛利。",
        risk:"越賣越累，BM Fit 卡住。"
      }
    ];
  }

  // ---------- Signal cards (for MVP validation) ----------
  const SIGNALS = [
    { id:"s1", title:"試用後 7 天內回訪", meta:"是否願意再來", bucketHint:"綠=回訪明顯；黃=偶發；紅=幾乎沒有" },
    { id:"s2", title:"願意推薦給跑友", meta:"口碑訊號", bucketHint:"綠=主動推薦；黃=被問才提；紅=不提" },
    { id:"s3", title:"願意付費（或留下訂金）", meta:"真實付費意圖", bucketHint:"綠=付費/訂金；黃=想要但拖；紅=只口頭" },
    { id:"s4", title:"關鍵體驗點被感知", meta:"貼地感/穩定/保護", bucketHint:"綠=清楚說出差異；黃=模糊；紅=無感" },
    { id:"s5", title:"獲客成本可接受", meta:"推廣效率", bucketHint:"綠=CAC 下降；黃=持平；紅=上升" },
    { id:"s6", title:"銷售週期縮短", meta:"成交更快", bucketHint:"綠=越做越快；黃=沒變；紅=越做越慢" },
    { id:"s7", title:"留存/回購", meta:"長期可能性", bucketHint:"綠=回購/續用；黃=觀望；紅=一次性" },
    { id:"s8", title:"毛利/良率改善", meta:"能不能長久做", bucketHint:"綠=改善可見；黃=微幅；紅=無解" },
  ];

  // ---------- Render MVP tab ----------
  function renderMvpTab(){
    ensureMvpState();
    ensureFitState();

    const wrap = document.createElement("div");

    const fitStage = state.fit?.diagnosis?.stagePrimary || "—";
    const fitHint = state.fit?.diagnosis?.rationaleText || "";

    const hero = document.createElement("div");
    hero.className = "panel";
    hero.innerHTML = `
      <div class="hero">
        <div class="hero-badge"></div>
        <div>
          <h2>MVP 驗證：把「不確定」變成可以被驗證的實驗</h2>
          <p>
            你在 Fit 判讀的主要階段是：<b>${escapeHTML(fitStage)}</b>。
            接下來不是做更完整的產品，而是做「能最快產生訊號」的驗證。
          </p>
          <div class="small-muted" style="margin-top:8px; white-space:pre-wrap; line-height:1.6">${escapeHTML(fitHint || "（尚未產生 Fit 診斷也沒關係，仍可直接做 MVP。）")}</div>
          <div class="mvp-hero-rail">
            <button class="btn primary" id="mvpMakeSheet">生成 MVP 實驗單</button>
            <button class="btn" id="mvpSnap">鎖定快照</button>
            <button class="btn" id="mvpAddNote">把 MVP 實驗單加入筆記</button>
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(hero);

    // Step 1: Top3 hypotheses (drag & drop)
    const step1 = document.createElement("div");
    step1.className = "panel";
    step1.innerHTML = `
      <div class="section-title">
        <h3>Step 1｜挑出你要先驗證的 Top 3 假設</h3>
        <div class="kicker"><span class="pill">拖曳假設卡到右邊 Top3</span></div>
      </div>

      <div class="grid-2">
        <div class="hypo-deck">
          <h4>假設卡（來源：陸王情境＋Fit 判讀）</h4>
          <div class="small-muted" style="margin-top:8px; line-height:1.6">
            你不是在挑「最重要的真理」，你是在挑「最該先被打臉或被證實的那三件事」。
          </div>
          <div class="hypo-cards" id="hypoDeck"></div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
            <button class="btn small" id="mvpResetTop3">清空 Top3</button>
            <button class="btn small" id="mvpReseed">重置假設卡（回到預設）</button>
          </div>
        </div>

        <div class="rank-zone" id="top3Zone">
          <h4>Top 3（你的驗證順序）</h4>
          <div class="small-muted" style="margin-top:8px; line-height:1.6">
            建議排序邏輯：先驗證「值不值得」的假設，再驗證「賣不賣得動」，最後才是「能不能長久」。
          </div>
          <div class="rank-list" id="top3List"></div>
          <div class="small-muted" style="margin-top:10px">
            提示：點右邊清除可把某張卡移回左邊；也可以用上下移動調整順序。
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(step1);

    // Step 2: Signal board (drag signals into Green/Yellow/Red)
    const step2 = document.createElement("div");
    step2.className = "panel";
    step2.innerHTML = `
      <div class="section-title">
        <h3>Step 2｜把「結果」變成可判讀的訊號（綠/黃/紅）</h3>
        <div class="kicker"><span class="pill">拖曳訊號卡到分類欄</span></div>
      </div>

      <div class="signal-board">
        <h4>訊號卡（你要拿什麼判讀 MVP）</h4>
        <div class="small-muted" style="margin-top:8px; line-height:1.6">
          綠＝值得加碼；黃＝要釐清/補實驗；紅＝可能要停損或轉向。這裡是「決策訊號」不是「漂亮數字」。
        </div>

        <div class="sig-deck" id="sigDeck"></div>

        <div class="signal-cols" id="sigCols">
          <!-- cols injected -->
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
          <button class="btn small" id="sigReset">清空分類</button>
          <button class="btn small" id="sigAutoFill">示範分類</button>
        </div>
      </div>
    `;
    wrap.appendChild(step2);

    // Step 3: Experiment sheet (auto for top3, editable)
    const step3 = document.createElement("div");
    step3.className = "panel";
    step3.innerHTML = `
      <div class="section-title">
        <h3>Step 3｜MVP 實驗單（可直接拿去做）</h3>
        <div class="kicker"><span class="pill">每個 Top3 假設都要對應：方法 × 指標 × 門檻 × 停損</span></div>
      </div>

      <div class="exp-sheet">
        <h4>你的實驗單</h4>
        <div class="small-muted" style="margin-top:8px; line-height:1.6">
          寫法建議：先寫「最小行為」而不是「最完整功能」。例如：先讓跑者「願意試＋願意回來」，再談大量鋪貨。
        </div>

        <div class="exp-list" id="expList"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
          <button class="btn primary" id="mvpMakeSheet2">重新生成實驗單（保留已填欄位）</button>
          <button class="btn" id="mvpSnap2">鎖定快照</button>
          <button class="btn" id="mvpAddNote2">加入筆記</button>
          <button class="btn small" id="mvpCheck">檢查完成度</button>
          <button class="btn small" id="mvpNext">下一步：Pivot 決策</button>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="font-weight:900">MVP 快照列表</div>
          <div class="small-muted" style="margin-top:8px; line-height:1.6">
            快照是用來保存「當下你認為最合理的實驗設計」。你可以在不同小組版本之間切換。
          </div>
          <div id="mvpSnapList" style="display:grid; gap:10px; margin-top:10px"></div>
        </div>
      </div>
    `;
    wrap.appendChild(step3);

    // mount events
    setTimeout(()=>{
      renderHypoDeck();
      renderTop3();
      wireTop3Zone();

      renderSignalDeck();
      renderSignalCols();
      updateMvpProgressUI();

      $("#mvpResetTop3").onclick = ()=>{
        if(!confirm("確定清空 Top3？")) return;
        state.mvp.rankTop3 = [];
        scheduleSave();
        renderHypoDeck();
        renderTop3();
        renderExperiments(true);
        autoUpdateProgress(); renderProgress();
      };

      $("#mvpReseed").onclick = ()=>{
        if(!confirm("確定重置假設卡？（會回到預設 6 張）")) return;
        state.mvp.hypotheses = seedMvpHypotheses();
        state.mvp.rankTop3 = [];
        state.mvp.experiments = {};
        scheduleSave();
        renderHypoDeck();
        renderTop3();
        renderExperiments(true);
        autoUpdateProgress(); renderProgress();
        toast("已重置假設卡。","ok");
      };

      $("#sigReset").onclick = ()=>{
        if(!confirm("確定清空訊號分類？")) return;
        state.mvp.signal.placements = {};
        scheduleSave();
        renderSignalDeck();
        renderSignalCols();
        updateMvpProgressUI();
        autoUpdateProgress(); renderProgress();
      };

      $("#sigAutoFill").onclick = ()=>{
        // quick demo mapping
        const map = {
          s1:"green", s2:"green", s3:"green",
          s4:"yellow", s5:"yellow",
          s6:"yellow",
          s7:"yellow",
          s8:"red"
        };
        state.mvp.signal.placements = map;
        scheduleSave();
        renderSignalDeck();
        renderSignalCols();
        updateMvpProgressUI();
        autoUpdateProgress(); renderProgress();
        toast("已填入示範分類（可自行調整）。","ok");
      };

      $("#mvpMakeSheet").onclick = ()=> { renderExperiments(true); toast("已生成/更新 MVP 實驗單。","ok"); };
      $("#mvpMakeSheet2").onclick = ()=> { renderExperiments(true); toast("已生成/更新 MVP 實驗單。","ok"); };
      $("#mvpSnap").onclick = ()=> mvpSnapshot();
      $("#mvpSnap2").onclick = ()=> mvpSnapshot();
      $("#mvpAddNote").onclick = ()=> addMvpNote();
      $("#mvpAddNote2").onclick = ()=> addMvpNote();

      $("#mvpCheck").onclick = ()=>{
        const c = computeMvpCompletion();
        if(c.done) toast("MVP 完成：Top3、訊號分類、實驗單與快照皆齊。","ok");
        else{
          const miss = [];
          if(c.top3Count < 3) miss.push("Top3 需滿 3");
          if(c.sigCount < 6) miss.push("至少分類 6 張訊號卡");
          if(c.expFilled < 2) miss.push("至少完成 2 份實驗卡（方法/指標/門檻/期間）");
          if(!c.hasSnap) miss.push("至少 1 份 MVP 快照");
          toast("尚未完成：" + miss.join("、"), "warn");
        }
        autoUpdateProgress(); renderProgress();
      };

      $("#mvpNext").onclick = ()=> navigate("pivot");

      renderExperiments(false);
      renderMvpSnapshots();
    },0);

    return wrap;
  }

  // ---------- MVP: Hypothesis deck + Top3 ----------
  function renderHypoDeck(){
    ensureMvpState();
    const el = $("#hypoDeck");
    if(!el) return;
    el.innerHTML = "";

    const top3 = new Set(state.mvp.rankTop3 || []);
    const hypos = state.mvp.hypotheses || [];

    // show only those not in top3
    const list = hypos.filter(h=> !top3.has(h.id));

    if(!list.length){
      el.innerHTML = `<div class="small-muted">所有假設都已進入 Top3（或你已挑滿）。你可從右邊移回。</div>`;
      return;
    }

    list.forEach(h=>{
      const card = document.createElement("div");
      card.className = "hypo-card";
      card.draggable = true;
      card.dataset.hid = h.id;
      card.innerHTML = `
        <div class="hypo-title">${escapeHTML(h.title)}</div>
        <div class="hypo-meta">
          <b>Fit 關聯：</b>${escapeHTML(h.stage.toUpperCase())}<br/>
          <b>Context：</b>${escapeHTML(h.context)}<br/>
          <b>風險：</b>${escapeHTML(h.risk)}
        </div>
      `;
      card.ondragstart = (e)=>{
        e.dataTransfer.setData("text/hypoId", h.id);
        e.dataTransfer.effectAllowed = "move";
      };
      el.appendChild(card);
    });
  }

  function wireTop3Zone(){
    const z = $("#top3Zone");
    if(!z) return;

    z.ondragover = (e)=>{ e.preventDefault(); z.classList.add("over"); };
    z.ondragleave = ()=> z.classList.remove("over");
    z.ondrop = (e)=>{
      e.preventDefault();
      z.classList.remove("over");
      const id = e.dataTransfer.getData("text/hypoId");
      if(!id) return;
      if((state.mvp.rankTop3||[]).includes(id)) return;
      if((state.mvp.rankTop3||[]).length >= 3){
        toast("Top3 已滿。先移除其中一張再放入。","warn");
        return;
      }
      state.mvp.rankTop3.push(id);
      scheduleSave();
      renderHypoDeck();
      renderTop3();
      renderExperiments(true);
      autoUpdateProgress(); renderProgress();
    };
  }

  function renderTop3(){
    ensureMvpState();
    const el = $("#top3List");
    if(!el) return;
    el.innerHTML = "";

    const top3 = state.mvp.rankTop3 || [];
    const map = new Map((state.mvp.hypotheses||[]).map(h=>[h.id,h]));

    if(top3.length === 0){
      el.innerHTML = `<div class="small-muted">拖曳左側假設卡到這裡。建議先挑 1 張就好，再慢慢補到 3 張。</div>`;
      return;
    }

    top3.forEach((id,idx)=>{
      const h = map.get(id);
      if(!h) return;

      const item = document.createElement("div");
      item.className = "rank-item";
      item.innerHTML = `
        <div class="rank-badge">${idx+1}</div>
        <div class="rank-body">
          <div style="font-weight:950">${escapeHTML(h.title)}</div>
          <div class="small-muted" style="margin-top:6px; line-height:1.5">
            Fit：<b>${escapeHTML(h.stage.toUpperCase())}</b>｜
            Context：${escapeHTML(h.context)}
          </div>
        </div>
        <div class="rank-actions">
          <button class="btn small" data-move="up" data-id="${h.id}">上移</button>
          <button class="btn small" data-move="down" data-id="${h.id}">下移</button>
          <button class="btn small danger" data-move="rm" data-id="${h.id}">移除</button>
        </div>
      `;
      el.appendChild(item);
    });

    $$("button[data-move]", el).forEach(b=>{
      b.onclick = ()=>{
        const act = b.getAttribute("data-move");
        const id = b.getAttribute("data-id");
        const arr = state.mvp.rankTop3 || [];
        const i = arr.indexOf(id);
        if(i<0) return;
        if(act==="rm"){
          arr.splice(i,1);
        }else if(act==="up" && i>0){
          [arr[i-1], arr[i]] = [arr[i], arr[i-1]];
        }else if(act==="down" && i<arr.length-1){
          [arr[i+1], arr[i]] = [arr[i], arr[i+1]];
        }
        scheduleSave();
        renderHypoDeck();
        renderTop3();
        renderExperiments(true);
        autoUpdateProgress(); renderProgress();
      };
    });
  }

  // ---------- MVP: Signal board ----------
  function renderSignalDeck(){
    ensureMvpState();
    const el = $("#sigDeck");
    if(!el) return;
    el.innerHTML = "";

    const placed = state.mvp.signal.placements || {};
    const unplaced = SIGNALS.filter(s=> !placed[s.id]);

    if(!unplaced.length){
      el.innerHTML = `<div class="small-muted">所有訊號卡都已分類。點右邊欄位的標籤可移回。</div>`;
      return;
    }

    unplaced.forEach(s=>{
      const card = document.createElement("div");
      card.className = "sig-card";
      card.draggable = true;
      card.dataset.sid = s.id;
      card.innerHTML = `
        <div class="sig-title">${escapeHTML(s.title)}</div>
        <div class="sig-meta">
          <b>用途：</b>${escapeHTML(s.meta)}<br/>
          <b>提示：</b>${escapeHTML(s.bucketHint)}
        </div>
      `;
      card.ondragstart = (e)=>{
        e.dataTransfer.setData("text/signalId", s.id);
        e.dataTransfer.effectAllowed = "move";
      };
      el.appendChild(card);
    });
  }

  function renderSignalCols(){
    ensureMvpState();
    const el = $("#sigCols");
    if(!el) return;
    el.innerHTML = "";

    const cols = [
      { id:"green", name:"綠（加碼）", desc:"訊號清楚，表示假設可能成立；可以加大樣本或加快迭代。"},
      { id:"yellow", name:"黃（補證據）", desc:"訊號模糊或互相矛盾；需要釐清實驗方法或族群/情境。"},
      { id:"red", name:"紅（停損/轉向）", desc:"訊號持續不成立；要考慮停損，或以「關聯性」方式轉向。"},
    ];

    const placements = state.mvp.signal.placements || {};
    const by = { green:[], yellow:[], red:[] };
    for(const s of SIGNALS){
      const b = placements[s.id];
      if(b && by[b]) by[b].push(s);
    }

    cols.forEach(c=>{
      const col = document.createElement("div");
      col.className = "sig-col";
      col.dataset.bucket = c.id;
      col.innerHTML = `
        <div class="sig-head">
          <b>${c.name}</b>
          <span class="pill">${by[c.id].length} 張</span>
        </div>
        <div class="small-muted" style="line-height:1.5">${escapeHTML(c.desc)}</div>
        <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:10px" id="sig_${c.id}"></div>
      `;

      // dnd
      col.ondragover = (e)=>{ e.preventDefault(); col.classList.add("over"); };
      col.ondragleave = ()=> col.classList.remove("over");
      col.ondrop = (e)=>{
        e.preventDefault();
        col.classList.remove("over");
        const sid = e.dataTransfer.getData("text/signalId");
        if(!sid) return;
        state.mvp.signal.placements[sid] = c.id;
        scheduleSave();
        renderSignalDeck();
        renderSignalCols();
        updateMvpProgressUI();
        autoUpdateProgress(); renderProgress();
      };

      el.appendChild(col);

      const list = $("#sig_"+c.id);
      by[c.id].forEach(s=>{
        const chip = document.createElement("div");
        chip.className = "sig-chip";
        chip.textContent = s.title;
        chip.title = "點一下移回訊號卡";
        chip.onclick = ()=>{
          delete state.mvp.signal.placements[s.id];
          scheduleSave();
          renderSignalDeck();
          renderSignalCols();
          updateMvpProgressUI();
          autoUpdateProgress(); renderProgress();
        };
        list.appendChild(chip);
      });
    });
  }

  // ---------- MVP: Experiment sheet ----------
  function renderExperiments(keepExisting=true){
    ensureMvpState();
    const el = $("#expList");
    if(!el) return;
    el.innerHTML = "";

    const top3 = state.mvp.rankTop3 || [];
    const map = new Map((state.mvp.hypotheses||[]).map(h=>[h.id,h]));

    if(top3.length === 0){
      el.innerHTML = `<div class="small-muted">先在 Step 1 選出 Top3，這裡才會生成對應的實驗卡。</div>`;
      return;
    }

    // Ensure experiment objects exist (preserve fields if keepExisting)
    top3.forEach((id,idx)=>{
      if(!state.mvp.experiments[id] || !keepExisting){
        const h = map.get(id);
        state.mvp.experiments[id] = Object.assign({
          metric: defaultMetricForHypo(h),
          threshold: "",
          method: defaultMethodForHypo(h),
          duration: "7 天",
          stopline: "",
          confidence: 50,
          notes: ""
        }, keepExisting && state.mvp.experiments[id] ? state.mvp.experiments[id] : {});
      }
    });

    scheduleSave();

    top3.forEach((id,idx)=>{
      const h = map.get(id);
      const e = state.mvp.experiments[id];
      if(!h || !e) return;

      const card = document.createElement("div");
      card.className = "exp-card";
      card.innerHTML = `
        <div class="top">
          <div>
            <b>實驗 #${idx+1}</b>｜
            <span class="pill">對應假設：${escapeHTML(h.stage.toUpperCase())}</span>
            <div style="font-weight:950; margin-top:6px">${escapeHTML(h.title)}</div>
            <div class="small-muted" style="margin-top:6px; line-height:1.5">
              Context：${escapeHTML(h.context)}<br/>
              風險：${escapeHTML(h.risk)}
            </div>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
            <button class="btn small" data-exp="autofill" data-id="${id}">套用建議模板</button>
            <button class="btn small danger" data-exp="clear" data-id="${id}">清空此卡</button>
          </div>
        </div>

        <div class="exp-row">
          <div class="mini-field">
            <label>關鍵指標（Metric）</label>
            <input type="text" id="exp_metric_${id}" placeholder="例：回訪率、付費轉換率、NPS、訂金率..." />
          </div>
          <div class="mini-field">
            <label>門檻（Threshold）</label>
            <input type="text" id="exp_thr_${id}" placeholder="例：回訪≥30%、訂金≥10%、NPS≥20..." />
          </div>
          <div class="mini-field">
            <label>驗證方法（Method）</label>
            <textarea id="exp_method_${id}" placeholder="用最小方式取得訊號：試跑活動、跑團合作、Landing Page + 訂金、原型試穿、A/B 敘事..."></textarea>
          </div>
          <div class="mini-field">
            <label>期間（Duration）</label>
            <input type="text" id="exp_dur_${id}" placeholder="例：7 天、2 週、3 場活動..." />
          </div>
          <div class="mini-field">
            <label>停損線（Stop line）</label>
            <input type="text" id="exp_stop_${id}" placeholder="例：若 2 週內回訪<10% 就停止/改族群..." />
          </div>
          <div class="mini-field">
            <label>補充備註（Notes）</label>
            <textarea id="exp_note_${id}" placeholder="例：避免干擾因素、取樣條件、誰負責、需要什麼資源..."></textarea>
          </div>
        </div>

        <div style="margin-top:10px">
          <div class="small-muted">你對這張實驗卡的信心（不是自我安慰，是你是否掌握了驗證方法）</div>
          <div class="slider" style="margin-top:8px">
            <input type="range" min="0" max="100" value="${e.confidence ?? 50}" id="exp_conf_${id}" />
            <span class="pill" id="exp_conf_pill_${id}">${e.confidence ?? 50}%</span>
          </div>
        </div>
      `;

      el.appendChild(card);

      // bind values
      $("#exp_metric_"+id).value = e.metric || "";
      $("#exp_thr_"+id).value = e.threshold || "";
      $("#exp_method_"+id).value = e.method || "";
      $("#exp_dur_"+id).value = e.duration || "";
      $("#exp_stop_"+id).value = e.stopline || "";
      $("#exp_note_"+id).value = e.notes || "";

      // bind events
      const bindInput = (sel, key)=>{
        $(sel).addEventListener("input", ()=>{
          state.mvp.experiments[id][key] = $(sel).value;
          scheduleSave();
          updateMvpProgressUI();
          autoUpdateProgress(); renderProgress();
        });
      };
      bindInput("#exp_metric_"+id, "metric");
      bindInput("#exp_thr_"+id, "threshold");
      bindInput("#exp_method_"+id, "method");
      bindInput("#exp_dur_"+id, "duration");
      bindInput("#exp_stop_"+id, "stopline");
      bindInput("#exp_note_"+id, "notes");

      $("#exp_conf_"+id).addEventListener("input", ()=>{
        const v = parseInt($("#exp_conf_"+id).value,10);
        $("#exp_conf_pill_"+id).textContent = v + "%";
        state.mvp.experiments[id].confidence = v;
        scheduleSave();
      });
    });

    $$("button[data-exp]", el).forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-id");
        const act = b.getAttribute("data-exp");
        const map = new Map((state.mvp.hypotheses||[]).map(h=>[h.id,h]));
        const h = map.get(id);

        if(act==="clear"){
          if(!confirm("確定清空這張實驗卡？")) return;
          state.mvp.experiments[id] = {
            metric:"",
            threshold:"",
            method:"",
            duration:"7 天",
            stopline:"",
            confidence:50,
            notes:""
          };
        }
        if(act==="autofill"){
          state.mvp.experiments[id] = Object.assign(state.mvp.experiments[id] || {}, {
            metric: defaultMetricForHypo(h),
            method: defaultMethodForHypo(h),
          });
        }
        scheduleSave();
        renderExperiments(true);
        updateMvpProgressUI();
        autoUpdateProgress(); renderProgress();
        toast("已更新實驗卡。","ok");
      };
    });

    updateMvpProgressUI();
  }

  function defaultMetricForHypo(h){
    if(!h) return "回訪率";
    const st = (h.stage||"vp").toLowerCase();
    if(st==="vp") return "回訪率 / 推薦意願";
    if(st==="gtm") return "付費轉換率 / CAC / 銷售週期";
    if(st==="bm") return "毛利率 / 留存率 / CAC 回收期";
    return "回訪率";
  }
  function defaultMethodForHypo(h){
    if(!h) return "用最小方式做測試：小型試用 + 明確門檻 + 停損線";
    const st = (h.stage||"vp").toLowerCase();
    if(st==="vp"){
      return "設計一個能「立刻感知差異」的試用情境（例如：試跑活動/原型試穿），收集回訪與推薦訊號；同時記錄痛點描述是否一致。";
    }
    if(st==="gtm"){
      return "用一個可重複的成交流程做小規模：Landing Page + 訂金/預購、跑團合作、定價敘事 A/B；觀察轉換率與 CAC。";
    }
    if(st==="bm"){
      return "先用小批量生產測試良率與成本；用報價/預購確認價格帶；把毛利與回收期算到可支撐下一輪迭代。";
    }
    return "用最小方式做測試：小型試用 + 明確門檻 + 停損線";
  }

  function updateMvpProgressUI(){
    // currently only used by checkers; keep reserved
  }

  // ---------- MVP snapshot + note ----------
  function buildMvpSheetText(){
    ensureMvpState();
    const top3 = state.mvp.rankTop3 || [];
    const map = new Map((state.mvp.hypotheses||[]).map(h=>[h.id,h]));
    const lines = [];
    lines.push("【MVP 實驗單】");
    lines.push("（目標：用最小方式取得可判讀訊號）");
    lines.push("");

    // Signals summary
    const by = { green:[], yellow:[], red:[] };
    const placements = state.mvp.signal.placements || {};
    for(const s of SIGNALS){
      const b = placements[s.id];
      if(b && by[b]) by[b].push(s.title);
    }
    lines.push("【訊號分類】");
    lines.push(`綠：${by.green.length ? by.green.join("、") : "—"}`);
    lines.push(`黃：${by.yellow.length ? by.yellow.join("、") : "—"}`);
    lines.push(`紅：${by.red.length ? by.red.join("、") : "—"}`);
    lines.push("");

    top3.forEach((id,idx)=>{
      const h = map.get(id);
      const e = state.mvp.experiments[id] || {};
      lines.push(`【實驗 #${idx+1}｜${h ? h.stage.toUpperCase() : "—"}】`);
      lines.push(h ? h.title : "(缺少假設)");
      lines.push(`Metric：${e.metric || "—"}`);
      lines.push(`Threshold：${e.threshold || "—"}`);
      lines.push(`Method：${(e.method||"—").replace(/\n/g," ")}`);
      lines.push(`Duration：${e.duration || "—"}`);
      lines.push(`Stop line：${e.stopline || "—"}`);
      lines.push(`Confidence：${e.confidence ?? 50}%`);
      if((e.notes||"").trim()) lines.push(`Notes：${e.notes.replace(/\n/g," ")}`);
      lines.push("");
    });

    return lines.join("\n");
  }

  function mvpSnapshot(){
    ensureMvpState();
    const c = computeMvpCompletion();
    if(!c.pass){
      toast("建議先完成 Top3、分類至少 6 張訊號卡，並填好至少 2 張實驗卡，再鎖定快照。","warn");
    }
    const snap = {
      id: uid(),
      createdAt: nowISO(),
      rankTop3: structuredClone(state.mvp.rankTop3),
      signal: structuredClone(state.mvp.signal),
      experiments: structuredClone(state.mvp.experiments),
      sheetText: buildMvpSheetText()
    };
    state.mvp.snapshots.unshift(snap);
    scheduleSave();
    renderMvpSnapshots();
    autoUpdateProgress(); renderProgress();
    toast("已鎖定 MVP 快照。","ok");
  }

  function addMvpNote(){
    addNote({
      title:"快照｜MVP 實驗單",
      content: buildMvpSheetText(),
      tags:["MVP","課堂"]
    });
  }

  function renderMvpSnapshots(){
    ensureMvpState();
    const el = $("#mvpSnapList");
    if(!el) return;
    el.innerHTML = "";

    const snaps = state.mvp.snapshots || [];
    if(!snaps.length){
      el.innerHTML = `<div class="small-muted">尚無快照。按「鎖定快照」即可生成。</div>`;
      return;
    }

    snaps.forEach((s,i)=>{
      const card = document.createElement("div");
      card.className = "card";
      const dt = new Date(s.createdAt).toLocaleString("zh-Hant");
      card.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
          <div style="font-weight:900">快照 #${snaps.length - i}</div>
          <div class="pill">${dt}</div>
        </div>
        <div class="small-muted" style="margin-top:8px; white-space:pre-wrap; line-height:1.6">${escapeHTML(s.sheetText || "")}</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
          <button class="btn small" data-mvp="apply" data-id="${s.id}">套用到目前</button>
          <button class="btn small" data-mvp="note" data-id="${s.id}">加入筆記</button>
          <button class="btn small danger" data-mvp="del" data-id="${s.id}">刪除</button>
        </div>
      `;
      el.appendChild(card);
    });

    $$("button[data-mvp]", el).forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-id");
        const act = b.getAttribute("data-mvp");
        const snap = (state.mvp.snapshots||[]).find(x=>x.id===id);
        if(!snap) return;

        if(act==="apply"){
          state.mvp.rankTop3 = structuredClone(snap.rankTop3);
          state.mvp.signal = structuredClone(snap.signal);
          state.mvp.experiments = structuredClone(snap.experiments);
          scheduleSave();
          toast("已套用 MVP 快照。","ok");
          renderMain();
        }
        if(act==="note"){
          addNote({ title:"快照｜MVP 實驗單", content: snap.sheetText || "" });
        }
        if(act==="del"){
          if(!confirm("確定刪除這份 MVP 快照？")) return;
          state.mvp.snapshots = state.mvp.snapshots.filter(x=>x.id!==id);
          scheduleSave();
          renderMvpSnapshots();
          autoUpdateProgress(); renderProgress();
          toast("已刪除快照。","ok");
        }
      };
    });
  }

  // ---------- Render Pivot tab ----------
  function renderPivotTab(){
    ensurePivotState();
    ensureMvpState();
    ensureFitState();

    const wrap = document.createElement("div");

    const hero = document.createElement("div");
    hero.className = "panel";
    hero.innerHTML = `
      <div class="hero">
        <div class="hero-badge"></div>
        <div>
          <h2>Pivot：不是「推翻」，而是「保留關聯性」地轉向</h2>
          <p>
            Pivot 的目的不是承認失敗，而是把你已經學到的東西，轉成下一個更可能成立的方向。
            這一頁會產出：<b>紅黃綠判讀 → Pivot 類型 → 舊→新假設連結 → 決策紀錄 → 快照</b>。
          </p>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
            <button class="btn primary" id="pivotMake">生成 Pivot 決策摘要</button>
            <button class="btn" id="pivotSnap">鎖定快照</button>
            <button class="btn" id="pivotAddNote">把 Pivot 摘要加入筆記</button>
          </div>
        </div>
      </div>
    `;
    wrap.appendChild(hero);

    // Board: traffic light based on MVP signals + experiment status
    const board = document.createElement("div");
    board.className = "panel";
    board.innerHTML = `
      <div class="section-title">
        <h3>Step 1｜紅黃綠：你應該「加碼、補證據、還是轉向」？</h3>
        <div class="kicker"><span class="pill">用 MVP 訊號做決策，而不是用感覺</span></div>
      </div>

      <div class="pivot-board">
        <h4>紅黃綠判讀</h4>
        <div class="small-muted" style="margin-top:8px; line-height:1.6">
          建議你用 Step 2 的訊號分類：綠多＝加碼；黃多＝補證據；紅多＝停損或轉向。
          你也可以在這裡手動選擇，並寫下理由（理由會進入決策紀錄）。
        </div>

        <div class="traffic">
          <div class="tbox" id="t_green">
            <div class="head">
              <b>綠（加碼）</b>
              <label class="pill" style="cursor:pointer"><input type="radio" name="trafficPick" value="green" /> 選擇</label>
            </div>
            <div class="desc">訊號清楚，多數假設可能成立。下一步：擴大樣本/加速迭代/補 GTM。</div>
          </div>
          <div class="tbox" id="t_yellow">
            <div class="head">
              <b>黃（補證據）</b>
              <label class="pill" style="cursor:pointer"><input type="radio" name="trafficPick" value="yellow" /> 選擇</label>
            </div>
            <div class="desc">訊號模糊或矛盾。下一步：改實驗方法、改族群/情境、補門檻或停損線。</div>
          </div>
          <div class="tbox" id="t_red">
            <div class="head">
              <b>紅（停損/轉向）</b>
              <label class="pill" style="cursor:pointer"><input type="radio" name="trafficPick" value="red" /> 選擇</label>
            </div>
            <div class="desc">訊號持續不成立。下一步：Pivot（保留關聯性）或明確停損。</div>
          </div>
        </div>

        <div class="field" style="margin-top:12px">
          <label>判讀理由（會寫入決策紀錄）</label>
          <textarea id="trafficWhy" placeholder="例：綠的訊號已經連續兩週成立，但 CAC 仍偏高，所以先選黃：補通路與成交流程的證據。"></textarea>
          <div class="hint">寫法：引用 1–2 個訊號（綠/黃/紅）→ 你的判讀 → 下一步要做什麼。</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
          <button class="btn small" id="trafficSuggest">根據 MVP 訊號自動建議</button>
          <button class="btn small danger" id="trafficReset">清空選擇</button>
        </div>
      </div>
    `;
    wrap.appendChild(board);

    // Step 2: Pivot type + old->new linkage
    const link = document.createElement("div");
    link.className = "panel";
    link.innerHTML = `
      <div class="section-title">
        <h3>Step 2｜Pivot 類型＋舊→新假設連結</h3>
        <div class="kicker"><span class="pill">關聯性：你保留了什麼？你改了什麼？</span></div>
      </div>

      <div class="linkmap">
        <div class="grid-2">
          <div>
            <div style="font-weight:950">Pivot 類型</div>
            <div class="small-muted" style="margin-top:8px; line-height:1.6">
              Pivot 不是「換題目」，而是把你已驗證/已被打臉的內容，轉成更可行的下一步。
            </div>

            <div class="mini-field" style="margin-top:10px">
              <label>選擇 Pivot 類型</label>
              <select id="pivotType">
                <option value="">（請選擇）</option>
                <option value="zoom-in">Zoom-in：縮小到一個最強功能/場景</option>
                <option value="zoom-out">Zoom-out：把目前功能當作更大產品的一部分</option>
                <option value="segment">客群轉向：換族群（保留核心價值）</option>
                <option value="channel">通路轉向：換通路/成交方式</option>
                <option value="tech">技術/製程轉向：換作法以解成本/良率</option>
                <option value="revenue">收入模式轉向：換定價/付費模式</option>
              </select>
            </div>

            <div class="mini-field" style="margin-top:10px">
              <label>舊假設（引用你的 Top3 或 Fit 判讀）</label>
              <textarea id="oldHypo" placeholder="例：跑者在長距離更在意貼地感＋保護的平衡；我們用足袋結構做跑鞋能顯著減痛。"></textarea>
            </div>
          </div>

          <div>
            <div style="font-weight:950">新假設（Pivot 後）</div>
            <div class="small-muted" style="margin-top:8px; line-height:1.6">
              新假設要能直接導向下一個 MVP。避免寫成「我們要更努力」；要寫成「某族群在某情境會採用某解法」。
            </div>

            <div class="mini-field" style="margin-top:10px">
              <label>新假設（至少 10 字）</label>
              <textarea id="newHypo" placeholder="例：先鎖定有傷痛史的跑者，在跑團試跑活動中提供『即時貼地差異』體驗，回訪≥30% 則加碼。"></textarea>
            </div>

            <div class="mini-field" style="margin-top:10px">
              <label>關聯性說明：你保留了什麼？你改了什麼？</label>
              <textarea id="linkReason" placeholder="例：保留：貼地差異的核心價值；改變：先換客群到腳感敏感者＋用跑團做通路驗證。"></textarea>
            </div>
          </div>
        </div>

        <div class="row">
          <span class="pill">舊假設</span>
          <span class="arrow">→</span>
          <span class="pill">Pivot 類型</span>
          <span class="arrow">→</span>
          <span class="pill">新假設</span>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
          <button class="btn small" id="pivotFillFromMvp">從 MVP Top3 自動帶入舊假設</button>
          <button class="btn small" id="pivotLog">寫入決策紀錄</button>
        </div>
      </div>
    `;
    wrap.appendChild(link);

    // Step 3: Decision log + snapshots
    const log = document.createElement("div");
    log.className = "panel";
    log.innerHTML = `
      <div class="section-title">
        <h3>Step 3｜決策紀錄與快照</h3>
        <div class="kicker"><span class="pill">用紀錄降低「事後合理化」</span></div>
      </div>

      <div class="card">
        <div style="font-weight:950">決策紀錄</div>
        <div class="small-muted" style="margin-top:8px; line-height:1.6">
          每一筆紀錄都要包含：紅黃綠判讀 → Pivot 類型 → 新假設 → 關聯性。
        </div>
        <div class="loglist" id="pivotLogList"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px">
          <button class="btn primary" id="pivotMake2">生成 Pivot 決策摘要</button>
          <button class="btn" id="pivotSnap2">鎖定快照</button>
          <button class="btn" id="pivotAddNote2">加入筆記</button>
          <button class="btn small" id="pivotCheck">檢查完成度</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:950">Pivot 快照列表</div>
        <div class="small-muted" style="margin-top:8px; line-height:1.6">
          快照會保存你此刻的判讀、Pivot 類型、新假設與紀錄。可用於課堂簡報或比較不同小組版本。
        </div>
        <div id="pivotSnapList" style="display:grid; gap:10px; margin-top:10px"></div>
      </div>
    `;
    wrap.appendChild(log);

    // mount events
    setTimeout(()=>{
      // Pre-fill traffic suggestion based on MVP signals
      $("#trafficSuggest").onclick = ()=>{
        const sug = suggestTrafficFromMvp();
        pickTraffic(sug.pick);
        $("#trafficWhy").value = sug.why;
        state.pivot.traffic.rationale = $("#trafficWhy").value;
        scheduleSave();
        autoUpdateProgress(); renderProgress();
        toast("已根據 MVP 訊號做出建議（可自行修改）。","ok");
      };

      $("#trafficReset").onclick = ()=>{
        if(!confirm("確定清空紅黃綠選擇？")) return;
        state.pivot.traffic = { green:false, yellow:false, red:false, rationale:"" };
        scheduleSave();
        renderMain();
      };

      // restore traffic radio
      const picked = state.pivot.traffic.green ? "green" : (state.pivot.traffic.yellow ? "yellow" : (state.pivot.traffic.red ? "red" : ""));
      if(picked){
        const r = document.querySelector(`input[name="trafficPick"][value="${picked}"]`);
        if(r) r.checked = true;
      }
      $("#trafficWhy").value = state.pivot.traffic.rationale || "";

      $$(`input[name="trafficPick"]`).forEach(r=>{
        r.onchange = ()=>{
          pickTraffic(r.value);
          scheduleSave();
          autoUpdateProgress(); renderProgress();
        };
      });

      $("#trafficWhy").addEventListener("input", ()=>{
        state.pivot.traffic.rationale = $("#trafficWhy").value;
        scheduleSave();
      });

      // pivot type + text fields
      $("#pivotType").value = state.pivot.pivotType || "";
      $("#oldHypo").value = state.pivot.oldHypoRef || "";
      $("#newHypo").value = state.pivot.newHypo || "";
      $("#linkReason").value = state.pivot.linkReason || "";

      $("#pivotType").addEventListener("change", ()=>{
        state.pivot.pivotType = $("#pivotType").value;
        scheduleSave();
        autoUpdateProgress(); renderProgress();
      });
      $("#oldHypo").addEventListener("input", ()=>{ state.pivot.oldHypoRef = $("#oldHypo").value; scheduleSave(); });
      $("#newHypo").addEventListener("input", ()=>{
        state.pivot.newHypo = $("#newHypo").value;
        scheduleSave();
        autoUpdateProgress(); renderProgress();
      });
      $("#linkReason").addEventListener("input", ()=>{ state.pivot.linkReason = $("#linkReason").value; scheduleSave(); });

      // Fill from MVP
      $("#pivotFillFromMvp").onclick = ()=>{
        const txt = buildOldHypoFromMvpTop3();
        $("#oldHypo").value = txt;
        state.pivot.oldHypoRef = txt;
        scheduleSave();
        toast("已從 MVP Top3 帶入舊假設。","ok");
      };

      // write log
      $("#pivotLog").onclick = ()=>{
        const entry = makePivotLogEntry();
        if(!entry.ok){
          toast(entry.msg, "warn");
          return;
        }
        state.pivot.decisionLog.unshift(entry.data);
        scheduleSave();
        renderPivotLog();
        autoUpdateProgress(); renderProgress();
        toast("已寫入決策紀錄。","ok");
      };

      $("#pivotMake").onclick = ()=> { toast("已更新 Pivot 摘要（請看決策紀錄）。","ok"); renderPivotLog(); };
      $("#pivotMake2").onclick = ()=> { toast("已更新 Pivot 摘要（請看決策紀錄）。","ok"); renderPivotLog(); };

      $("#pivotSnap").onclick = ()=> pivotSnapshot();
      $("#pivotSnap2").onclick = ()=> pivotSnapshot();
      $("#pivotAddNote").onclick = ()=> addPivotNote();
      $("#pivotAddNote2").onclick = ()=> addPivotNote();

      $("#pivotCheck").onclick = ()=>{
        const c = computePivotCompletion();
        if(c.done) toast("Pivot 完成：紅黃綠＋Pivot 類型＋新假設＋紀錄＋快照。","ok");
        else{
          const miss = [];
          if(!c.trafficChosen) miss.push("選擇紅/黃/綠");
          if(!c.hasType) miss.push("選擇 Pivot 類型");
          if(!c.hasNew) miss.push("新假設至少 10 字");
          if(!c.hasLog) miss.push("至少 1 筆決策紀錄");
          if(!c.hasSnap) miss.push("至少 1 份 Pivot 快照");
          toast("尚未完成：" + miss.join("、"), "warn");
        }
        autoUpdateProgress(); renderProgress();
      };

      renderPivotLog();
      renderPivotSnapshots();
    },0);

    return wrap;
  }

  function pickTraffic(v){
    ensurePivotState();
    state.pivot.traffic.green = (v==="green");
    state.pivot.traffic.yellow = (v==="yellow");
    state.pivot.traffic.red = (v==="red");
  }

  function suggestTrafficFromMvp(){
    ensureMvpState();
    const p = state.mvp.signal.placements || {};
    let g=0,y=0,r=0;
    for(const sid of Object.keys(p)){
      if(p[sid]==="green") g++;
      if(p[sid]==="yellow") y++;
      if(p[sid]==="red") r++;
    }

    // simple heuristic
    let pick = "yellow";
    if(g >= 4 && r <= 1) pick = "green";
    else if(r >= 3) pick = "red";
    else pick = "yellow";

    const why = `根據 MVP 訊號分類：綠=${g}、黃=${y}、紅=${r}。\n判讀：先選「${pick==="green"?"綠（加碼）":pick==="yellow"?"黃（補證據）":"紅（停損/轉向）"}」。\n下一步：把你最不確定的那一項訊號，再補一次更乾淨的實驗（或明確停損）。`;
    return { pick, why };
  }

  function buildOldHypoFromMvpTop3(){
    ensureMvpState();
    const top3 = state.mvp.rankTop3 || [];
    const map = new Map((state.mvp.hypotheses||[]).map(h=>[h.id,h]));
    if(!top3.length) return (state.fit?.diagnosis?.rationaleText || "").trim() || "";
    const lines = [];
    top3.forEach((id,idx)=>{
      const h = map.get(id);
      if(h) lines.push(`${idx+1}. ${h.title}`);
    });
    return lines.join("\n");
  }

  function makePivotLogEntry(){
    ensurePivotState();
    const t = state.pivot.traffic || {};
    const traffic = t.green ? "綠（加碼）" : (t.yellow ? "黃（補證據）" : (t.red ? "紅（停損/轉向）" : ""));
    if(!traffic) return { ok:false, msg:"先選擇紅/黃/綠。"};
    if(!state.pivot.pivotType) return { ok:false, msg:"請選擇 Pivot 類型。"};
    if((state.pivot.newHypo||"").trim().length < 10) return { ok:false, msg:"新假設至少 10 字，請寫得更具體。"};
    if((state.pivot.oldHypoRef||"").trim().length < 5) return { ok:false, msg:"請填入舊假設（可從 MVP Top3 自動帶入）。"};
    if((state.pivot.linkReason||"").trim().length < 6) return { ok:false, msg:"請寫關聯性說明（保留什麼、改什麼）。"};

    const typeLabel = pivotTypeLabel(state.pivot.pivotType);
    const entry = {
      id: uid(),
      createdAt: nowISO(),
      traffic,
      trafficWhy: (state.pivot.traffic.rationale || "").trim(),
      pivotType: state.pivot.pivotType,
      pivotTypeLabel: typeLabel,
      oldHypo: state.pivot.oldHypoRef.trim(),
      newHypo: state.pivot.newHypo.trim(),
      linkReason: state.pivot.linkReason.trim()
    };
    return { ok:true, data: entry };
  }

  function pivotTypeLabel(v){
    const map = {
      "zoom-in":"Zoom-in：縮小到一個最強功能/場景",
      "zoom-out":"Zoom-out：把目前功能當作更大產品的一部分",
      "segment":"客群轉向：換族群（保留核心價值）",
      "channel":"通路轉向：換通路/成交方式",
      "tech":"技術/製程轉向：換作法以解成本/良率",
      "revenue":"收入模式轉向：換定價/付費模式"
    };
    return map[v] || v || "";
  }

  function renderPivotLog(){
    ensurePivotState();
    const el = $("#pivotLogList");
    if(!el) return;
    el.innerHTML = "";

    const logs = state.pivot.decisionLog || [];
    if(!logs.length){
      el.innerHTML = `<div class="small-muted">尚無決策紀錄。按「寫入決策紀錄」即可新增。</div>`;
      return;
    }

    logs.forEach((x,i)=>{
      const card = document.createElement("div");
      card.className = "card";
      const dt = new Date(x.createdAt).toLocaleString("zh-Hant");
      card.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
          <div style="font-weight:950">紀錄 #${logs.length - i}</div>
          <div class="pill">${dt}</div>
        </div>

        <div class="small-muted" style="margin-top:8px; line-height:1.6">
          <b>判讀：</b>${escapeHTML(x.traffic)}<br/>
          <b>Pivot 類型：</b>${escapeHTML(x.pivotTypeLabel)}
        </div>

        <div class="card" style="margin-top:10px; background: rgba(255,255,255,.78)">
          <div class="small-muted" style="white-space:pre-wrap; line-height:1.6"><b>理由：</b>${escapeHTML(x.trafficWhy || "（無）")}</div>
        </div>

        <div class="linkmap" style="margin-top:10px">
          <div class="small-muted" style="white-space:pre-wrap; line-height:1.6"><b>舊假設：</b>\n${escapeHTML(x.oldHypo)}</div>
          <div class="row"><span class="arrow">→</span><span class="pill">${escapeHTML(x.pivotTypeLabel)}</span><span class="arrow">→</span></div>
          <div class="small-muted" style="white-space:pre-wrap; line-height:1.6"><b>新假設：</b>\n${escapeHTML(x.newHypo)}</div>
          <div class="card" style="margin-top:10px; background: rgba(255,255,255,.78)">
            <div class="small-muted" style="white-space:pre-wrap; line-height:1.6"><b>關聯性：</b>\n${escapeHTML(x.linkReason)}</div>
          </div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
          <button class="btn small" data-pv="apply" data-id="${x.id}">套用到目前欄位</button>
          <button class="btn small" data-pv="note" data-id="${x.id}">加入筆記</button>
          <button class="btn small danger" data-pv="del" data-id="${x.id}">刪除</button>
        </div>
      `;
      el.appendChild(card);
    });

    $$("button[data-pv]", el).forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-id");
        const act = b.getAttribute("data-pv");
        const entry = (state.pivot.decisionLog||[]).find(x=>x.id===id);
        if(!entry) return;

        if(act==="apply"){
          // apply back to fields
          const trafficPick = entry.traffic.includes("綠") ? "green" : (entry.traffic.includes("黃") ? "yellow" : "red");
          pickTraffic(trafficPick);
          state.pivot.traffic.rationale = entry.trafficWhy || "";
          state.pivot.pivotType = entry.pivotType || "";
          state.pivot.oldHypoRef = entry.oldHypo || "";
          state.pivot.newHypo = entry.newHypo || "";
          state.pivot.linkReason = entry.linkReason || "";
          scheduleSave();
          toast("已套用到目前欄位。","ok");
          renderMain();
        }

        if(act==="note"){
          addNote({
            title:"紀錄｜Pivot 決策",
            content: buildPivotEntryText(entry),
            tags:["Pivot","課堂"]
          });
        }

        if(act==="del"){
          if(!confirm("確定刪除這筆決策紀錄？")) return;
          state.pivot.decisionLog = state.pivot.decisionLog.filter(x=>x.id!==id);
          scheduleSave();
          renderPivotLog();
          autoUpdateProgress(); renderProgress();
          toast("已刪除決策紀錄。","ok");
        }
      };
    });
  }

  function buildPivotEntryText(entry){
    const lines = [];
    lines.push("【Pivot 決策紀錄】");
    lines.push(`判讀：${entry.traffic}`);
    lines.push(`Pivot 類型：${entry.pivotTypeLabel}`);
    lines.push("");
    lines.push("理由：");
    lines.push(entry.trafficWhy || "（無）");
    lines.push("");
    lines.push("舊假設：");
    lines.push(entry.oldHypo || "—");
    lines.push("");
    lines.push("新假設：");
    lines.push(entry.newHypo || "—");
    lines.push("");
    lines.push("關聯性（保留什麼／改什麼）：");
    lines.push(entry.linkReason || "—");
    return lines.join("\n");
  }

  function buildPivotSummaryText(){
    ensurePivotState();
    const t = state.pivot.traffic || {};
    const traffic = t.green ? "綠（加碼）" : (t.yellow ? "黃（補證據）" : (t.red ? "紅（停損/轉向）" : "未選擇"));
    const typeLabel = pivotTypeLabel(state.pivot.pivotType);

    const lines = [];
    lines.push("【Pivot 摘要】");
    lines.push(`判讀：${traffic}`);
    lines.push(`Pivot 類型：${typeLabel || "—"}`);
    lines.push("");
    lines.push("理由：");
    lines.push((state.pivot.traffic.rationale || "").trim() || "（無）");
    lines.push("");
    lines.push("舊假設：");
    lines.push((state.pivot.oldHypoRef || "").trim() || "—");
    lines.push("");
    lines.push("新假設：");
    lines.push((state.pivot.newHypo || "").trim() || "—");
    lines.push("");
    lines.push("關聯性：");
    lines.push((state.pivot.linkReason || "").trim() || "—");
    lines.push("");
    if((state.pivot.decisionLog||[]).length){
      lines.push("（附：決策紀錄摘要）");
      const latest = state.pivot.decisionLog[0];
      lines.push("- " + (latest.createdAt ? new Date(latest.createdAt).toLocaleString("zh-Hant") : ""));
      lines.push("- " + latest.traffic + "｜" + latest.pivotTypeLabel);
    }
    return lines.join("\n");
  }

  function pivotSnapshot(){
    ensurePivotState();
    const c = computePivotCompletion();
    if(!c.pass){
      toast("建議先完成：紅黃綠＋Pivot 類型＋新假設＋至少 1 筆決策紀錄，再鎖定快照。","warn");
    }
    const snap = {
      id: uid(),
      createdAt: nowISO(),
      traffic: structuredClone(state.pivot.traffic),
      pivotType: state.pivot.pivotType,
      oldHypoRef: state.pivot.oldHypoRef,
      newHypo: state.pivot.newHypo,
      linkReason: state.pivot.linkReason,
      decisionLog: structuredClone(state.pivot.decisionLog),
      summaryText: buildPivotSummaryText()
    };
    state.pivot.snapshots.unshift(snap);
    scheduleSave();
    renderPivotSnapshots();
    autoUpdateProgress(); renderProgress();
    toast("已鎖定 Pivot 快照。","ok");
  }

  function addPivotNote(){
    addNote({
      title:"快照｜Pivot 摘要",
      content: buildPivotSummaryText(),
      tags:["Pivot","課堂"]
    });
  }

  function renderPivotSnapshots(){
    ensurePivotState();
    const el = $("#pivotSnapList");
    if(!el) return;
    el.innerHTML = "";

    const snaps = state.pivot.snapshots || [];
    if(!snaps.length){
      el.innerHTML = `<div class="small-muted">尚無快照。按「鎖定快照」即可生成。</div>`;
      return;
    }

    snaps.forEach((s,i)=>{
      const card = document.createElement("div");
      card.className = "card";
      const dt = new Date(s.createdAt).toLocaleString("zh-Hant");
      card.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
          <div style="font-weight:900">快照 #${snaps.length - i}</div>
          <div class="pill">${dt}</div>
        </div>
        <div class="small-muted" style="margin-top:8px; white-space:pre-wrap; line-height:1.6">${escapeHTML(s.summaryText || "")}</div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
          <button class="btn small" data-ps="apply" data-id="${s.id}">套用到目前</button>
          <button class="btn small" data-ps="note" data-id="${s.id}">加入筆記</button>
          <button class="btn small danger" data-ps="del" data-id="${s.id}">刪除</button>
        </div>
      `;
      el.appendChild(card);
    });

    $$("button[data-ps]", el).forEach(b=>{
      b.onclick = ()=>{
        const id = b.getAttribute("data-id");
        const act = b.getAttribute("data-ps");
        const snap = (state.pivot.snapshots||[]).find(x=>x.id===id);
        if(!snap) return;

        if(act==="apply"){
          state.pivot.traffic = structuredClone(snap.traffic);
          state.pivot.pivotType = snap.pivotType || "";
          state.pivot.oldHypoRef = snap.oldHypoRef || "";
          state.pivot.newHypo = snap.newHypo || "";
          state.pivot.linkReason = snap.linkReason || "";
          state.pivot.decisionLog = structuredClone(snap.decisionLog || []);
          scheduleSave();
          toast("已套用 Pivot 快照。","ok");
          renderMain();
        }
        if(act==="note"){
          addNote({ title:"快照｜Pivot 摘要", content: snap.summaryText || "" });
        }
        if(act==="del"){
          if(!confirm("確定刪除這份 Pivot 快照？")) return;
          state.pivot.snapshots = state.pivot.snapshots.filter(x=>x.id!==id);
          scheduleSave();
          renderPivotSnapshots();
          autoUpdateProgress(); renderProgress();
          toast("已刪除快照。","ok");
        }
      };
    });
  }

  // ---------- Utility: escapeHTML (in case Part1 didn't expose) ----------
  if(typeof escapeHTML !== "function"){
    function escapeHTML(s){
      return (s||"")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
  }

  // ---------- Final: refresh progress once ----------
  ensureMvpState();
  ensurePivotState();
  autoUpdateProgress();
  renderProgress();
</script>

